"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuthorizationRequest = void 0;
const PresentationExchange_1 = require("../authorization-response/PresentationExchange");
const did_1 = require("../did");
const helpers_1 = require("../helpers");
const SIOPSpecVersion_1 = require("../helpers/SIOPSpecVersion");
const request_object_1 = require("../request-object");
const types_1 = require("../types");
const Opts_1 = require("./Opts");
const Payload_1 = require("./Payload");
const URI_1 = require("./URI");
class AuthorizationRequest {
    constructor(payload, requestObject, opts, uri) {
        this._options = opts;
        this._payload = (0, helpers_1.removeNullUndefined)(payload);
        this._requestObject = requestObject;
        this._uri = uri;
    }
    static fromUriOrJwt(jwtOrUri) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!jwtOrUri) {
                throw Error(types_1.SIOPErrors.NO_REQUEST);
            }
            return typeof jwtOrUri === 'string' && jwtOrUri.startsWith('ey')
                ? yield AuthorizationRequest.fromJwt(jwtOrUri)
                : yield AuthorizationRequest.fromURI(jwtOrUri);
        });
    }
    static fromPayload(payload) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!payload) {
                throw Error(types_1.SIOPErrors.NO_REQUEST);
            }
            const requestObject = yield request_object_1.RequestObject.fromAuthorizationRequestPayload(payload);
            return new AuthorizationRequest(payload, requestObject);
        });
    }
    static fromOpts(opts, requestObject) {
        return __awaiter(this, void 0, void 0, function* () {
            // todo: response_uri/redirect_uri is not hooked up from opts!
            if (!opts || !opts.requestObject) {
                throw Error(types_1.SIOPErrors.BAD_PARAMS);
            }
            (0, Opts_1.assertValidAuthorizationRequestOpts)(opts);
            const requestObjectArg = opts.requestObject.passBy !== types_1.PassBy.NONE ? (requestObject ? requestObject : yield request_object_1.RequestObject.fromOpts(opts)) : undefined;
            const requestPayload = (opts === null || opts === void 0 ? void 0 : opts.payload) ? yield (0, Payload_1.createAuthorizationRequestPayload)(opts, requestObjectArg) : undefined;
            return new AuthorizationRequest(requestPayload, requestObjectArg, opts);
        });
    }
    get payload() {
        return this._payload;
    }
    get requestObject() {
        return this._requestObject;
    }
    get options() {
        return this._options;
    }
    hasRequestObject() {
        return this.requestObject !== undefined;
    }
    getSupportedVersion() {
        var _a, _b, _c, _d, _e;
        return __awaiter(this, void 0, void 0, function* () {
            if ((_a = this.options) === null || _a === void 0 ? void 0 : _a.version) {
                return this.options.version;
            }
            else if (((_c = (_b = this._uri) === null || _b === void 0 ? void 0 : _b.encodedUri) === null || _c === void 0 ? void 0 : _c.startsWith(types_1.Schema.OPENID_VC)) || ((_e = (_d = this._uri) === null || _d === void 0 ? void 0 : _d.scheme) === null || _e === void 0 ? void 0 : _e.startsWith(types_1.Schema.OPENID_VC))) {
                return types_1.SupportedVersion.JWT_VC_PRESENTATION_PROFILE_v1;
            }
            return (yield this.getSupportedVersionsFromPayload())[0];
        });
    }
    getSupportedVersionsFromPayload() {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            const mergedPayload = Object.assign(Object.assign({}, this.payload), (yield ((_a = this.requestObject) === null || _a === void 0 ? void 0 : _a.getPayload())));
            return (0, SIOPSpecVersion_1.authorizationRequestVersionDiscovery)(mergedPayload);
        });
    }
    uri() {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this._uri) {
                this._uri = yield URI_1.URI.fromAuthorizationRequest(this);
            }
            return this._uri;
        });
    }
    /**
     * Verifies a SIOP Request JWT on OP side
     *
     * @param opts
     */
    verify(opts) {
        var _a, _b;
        return __awaiter(this, void 0, void 0, function* () {
            (0, Opts_1.assertValidVerifyAuthorizationRequestOpts)(opts);
            let requestObjectPayload;
            let verifiedJwt;
            const jwt = yield this.requestObjectJwt();
            if (jwt) {
                (0, did_1.parseJWT)(jwt);
                const resolver = (0, did_1.getResolver)(opts.verification.resolveOpts);
                const options = Object.assign(Object.assign({}, (_b = (_a = opts.verification) === null || _a === void 0 ? void 0 : _a.resolveOpts) === null || _b === void 0 ? void 0 : _b.jwtVerifyOpts), { resolver, audience: (0, did_1.getAudience)(jwt) });
                verifiedJwt = yield (0, did_1.verifyDidJWT)(jwt, resolver, options);
                if (!verifiedJwt || !verifiedJwt.payload) {
                    throw Error(types_1.SIOPErrors.ERROR_VERIFYING_SIGNATURE);
                }
                requestObjectPayload = verifiedJwt.payload;
                if (this.hasRequestObject() && !this.payload.request_uri) {
                    // Put back the request object as that won't be present yet
                    this.payload.request = jwt;
                }
            }
            // AuthorizationRequest.assertValidRequestObject(origAuthenticationRequest);
            // We use the orig request for default values, but the JWT payload contains signed request object properties
            const mergedPayload = Object.assign(Object.assign({}, this.payload), requestObjectPayload);
            if (opts.state && mergedPayload.state !== opts.state) {
                throw new Error(`${types_1.SIOPErrors.BAD_STATE} payload: ${mergedPayload.state}, supplied: ${opts.state}`);
            }
            else if (opts.nonce && mergedPayload.nonce !== opts.nonce) {
                throw new Error(`${types_1.SIOPErrors.BAD_NONCE} payload: ${mergedPayload.nonce}, supplied: ${opts.nonce}`);
            }
            const registrationPropertyKey = mergedPayload['registration'] || mergedPayload['registration_uri'] ? 'registration' : 'client_metadata';
            let registrationMetadataPayload;
            if (mergedPayload[registrationPropertyKey] || mergedPayload[`${registrationPropertyKey}_uri`]) {
                registrationMetadataPayload = yield (0, helpers_1.fetchByReferenceOrUseByValue)(mergedPayload[`${registrationPropertyKey}_uri`], mergedPayload[registrationPropertyKey]);
                (0, Payload_1.assertValidRPRegistrationMedataPayload)(registrationMetadataPayload);
                // TODO: We need to do something with the metadata probably
            }
            // When the response_uri parameter is present, the redirect_uri Authorization Request parameter MUST NOT be present. If the redirect_uri Authorization Request parameter is present when the Response Mode is direct_post, the Wallet MUST return an invalid_request Authorization Response error.
            let responseURIType;
            let responseURI;
            if (mergedPayload.redirect_uri && mergedPayload.response_uri) {
                throw new Error(`${types_1.SIOPErrors.INVALID_REQUEST}, redirect_uri cannot be used together with response_uri`);
            }
            else if (mergedPayload.redirect_uri) {
                responseURIType = 'redirect_uri';
                responseURI = mergedPayload.redirect_uri;
            }
            else if (mergedPayload.response_uri) {
                responseURIType = 'response_uri';
                responseURI = mergedPayload.response_uri;
            }
            else if (mergedPayload.client_id_scheme === 'redirect_uri' && mergedPayload.client_id) {
                responseURIType = 'redirect_uri';
                responseURI = mergedPayload.client_id;
            }
            else {
                throw new Error(`${types_1.SIOPErrors.INVALID_REQUEST}, redirect_uri or response_uri is needed`);
            }
            yield (0, Payload_1.checkWellknownDIDFromRequest)(mergedPayload, opts);
            // TODO: we need to verify somewhere that if response_mode is direct_post, that the response_uri may be present,
            // BUT not both redirect_uri and response_uri. What is the best place to do this?
            const presentationDefinitions = yield PresentationExchange_1.PresentationExchange.findValidPresentationDefinitions(mergedPayload, yield this.getSupportedVersion());
            return Object.assign(Object.assign({}, verifiedJwt), { responseURIType,
                responseURI, clientIdScheme: mergedPayload.client_id_scheme, correlationId: opts.correlationId, authorizationRequest: this, verifyOpts: opts, presentationDefinitions,
                registrationMetadataPayload, requestObject: this.requestObject, authorizationRequestPayload: this.payload, versions: yield this.getSupportedVersionsFromPayload() });
        });
    }
    static verify(requestOrUri, verifyOpts) {
        return __awaiter(this, void 0, void 0, function* () {
            (0, Opts_1.assertValidVerifyAuthorizationRequestOpts)(verifyOpts);
            const authorizationRequest = yield AuthorizationRequest.fromUriOrJwt(requestOrUri);
            return yield authorizationRequest.verify(verifyOpts);
        });
    }
    requestObjectJwt() {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            return yield ((_a = this.requestObject) === null || _a === void 0 ? void 0 : _a.toJwt());
        });
    }
    static fromJwt(jwt) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!jwt) {
                throw Error(types_1.SIOPErrors.BAD_PARAMS);
            }
            const requestObject = yield request_object_1.RequestObject.fromJwt(jwt);
            const payload = Object.assign({}, (yield requestObject.getPayload()));
            // Although this was a RequestObject we instantiate it as AuthzRequest and then copy in the JWT as the request Object
            payload.request = jwt;
            return new AuthorizationRequest(Object.assign({}, payload), requestObject);
        });
    }
    static fromURI(uri) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!uri) {
                throw Error(types_1.SIOPErrors.BAD_PARAMS);
            }
            const uriObject = typeof uri === 'string' ? yield URI_1.URI.fromUri(uri) : uri;
            const requestObject = yield request_object_1.RequestObject.fromJwt(uriObject.requestObjectJwt);
            return new AuthorizationRequest(uriObject.authorizationRequestPayload, requestObject, undefined, uriObject);
        });
    }
    toStateInfo() {
        var _a, _b;
        return __awaiter(this, void 0, void 0, function* () {
            const requestObject = yield this.requestObject.getPayload();
            return {
                client_id: this.options.clientMetadata.client_id,
                iat: (_a = requestObject.iat) !== null && _a !== void 0 ? _a : this.payload.iat,
                nonce: (_b = requestObject.nonce) !== null && _b !== void 0 ? _b : this.payload.nonce,
                state: this.payload.state,
            };
        });
    }
    containsResponseType(singleType) {
        return __awaiter(this, void 0, void 0, function* () {
            const responseType = yield this.getMergedProperty('response_type');
            return (responseType === null || responseType === void 0 ? void 0 : responseType.includes(singleType)) === true;
        });
    }
    getMergedProperty(key) {
        return __awaiter(this, void 0, void 0, function* () {
            const merged = yield this.mergedPayloads();
            return merged[key];
        });
    }
    mergedPayloads() {
        return __awaiter(this, void 0, void 0, function* () {
            return Object.assign(Object.assign({}, this.payload), (this.requestObject && (yield this.requestObject.getPayload())));
        });
    }
    getPresentationDefinitions(version) {
        return __awaiter(this, void 0, void 0, function* () {
            return yield PresentationExchange_1.PresentationExchange.findValidPresentationDefinitions(yield this.mergedPayloads(), version);
        });
    }
}
exports.AuthorizationRequest = AuthorizationRequest;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXV0aG9yaXphdGlvblJlcXVlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYXV0aG9yaXphdGlvbi1yZXF1ZXN0L0F1dGhvcml6YXRpb25SZXF1ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUdBLHlGQUFzRjtBQUN0RixnQ0FBMEU7QUFDMUUsd0NBQStFO0FBQy9FLGdFQUFrRjtBQUNsRixzREFBa0Q7QUFDbEQsb0NBYWtCO0FBRWxCLGlDQUF3RztBQUN4Ryx1Q0FBb0k7QUFDcEksK0JBQTRCO0FBRzVCLE1BQWEsb0JBQW9CO0lBTS9CLFlBQW9CLE9BQW9DLEVBQUUsYUFBNkIsRUFBRSxJQUFxQyxFQUFFLEdBQVM7UUFDdkksSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFDckIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFBLDZCQUFtQixFQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzdDLElBQUksQ0FBQyxjQUFjLEdBQUcsYUFBYSxDQUFDO1FBQ3BDLElBQUksQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDO0lBQ2xCLENBQUM7SUFFTSxNQUFNLENBQU8sWUFBWSxDQUFDLFFBQXNCOztZQUNyRCxJQUFJLENBQUMsUUFBUSxFQUFFO2dCQUNiLE1BQU0sS0FBSyxDQUFDLGtCQUFVLENBQUMsVUFBVSxDQUFDLENBQUM7YUFDcEM7WUFDRCxPQUFPLE9BQU8sUUFBUSxLQUFLLFFBQVEsSUFBSSxRQUFRLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQztnQkFDOUQsQ0FBQyxDQUFDLE1BQU0sb0JBQW9CLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQztnQkFDOUMsQ0FBQyxDQUFDLE1BQU0sb0JBQW9CLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ25ELENBQUM7S0FBQTtJQUVNLE1BQU0sQ0FBTyxXQUFXLENBQUMsT0FBb0M7O1lBQ2xFLElBQUksQ0FBQyxPQUFPLEVBQUU7Z0JBQ1osTUFB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