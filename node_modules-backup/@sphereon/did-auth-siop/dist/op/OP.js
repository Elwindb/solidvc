"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.OP = void 0;
const uuid_1 = require("uuid");
const authorization_request_1 = require("../authorization-request");
const Opts_1 = require("../authorization-request/Opts");
const authorization_response_1 = require("../authorization-response");
const helpers_1 = require("../helpers");
const SIOPSpecVersion_1 = require("../helpers/SIOPSpecVersion");
const types_1 = require("../types");
const OPBuilder_1 = require("./OPBuilder");
const Opts_2 = require("./Opts");
// The OP publishes the formats it supports using the vp_formats_supported metadata parameter as defined above in its "openid-configuration".
class OP {
    constructor(opts) {
        var _a;
        this._createResponseOptions = Object.assign({}, (0, Opts_2.createResponseOptsFromBuilderOrExistingOpts)(opts));
        this._verifyRequestOptions = Object.assign({}, (0, Opts_2.createVerifyRequestOptsFromBuilderOrExistingOpts)(opts));
        this._eventEmitter = (_a = opts.builder) === null || _a === void 0 ? void 0 : _a.eventEmitter;
    }
    /**
     * This method tries to infer the SIOP specs version based on the request payload.
     * If the version cannot be inferred or is not supported it throws an exception.
     * This method needs to be called to ensure the OP can handle the request
     * @param requestJwtOrUri
     * @param requestOpts
     */
    verifyAuthorizationRequest(requestJwtOrUri, requestOpts) {
        return __awaiter(this, void 0, void 0, function* () {
            const correlationId = (requestOpts === null || requestOpts === void 0 ? void 0 : requestOpts.correlationId) || (0, uuid_1.v4)();
            const authorizationRequest = yield authorization_request_1.AuthorizationRequest.fromUriOrJwt(requestJwtOrUri)
                .then((result) => {
                void this.emitEvent(types_1.AuthorizationEvents.ON_AUTH_REQUEST_RECEIVED_SUCCESS, { correlationId, subject: result });
                return result;
            })
                .catch((error) => {
                void this.emitEvent(types_1.AuthorizationEvents.ON_AUTH_REQUEST_RECEIVED_FAILED, {
                    correlationId,
                    subject: requestJwtOrUri,
                    error,
                });
                throw error;
            });
            return authorizationRequest
                .verify(this.newVerifyAuthorizationRequestOpts(Object.assign(Object.assign({}, requestOpts), { correlationId })))
                .then((verifiedAuthorizationRequest) => {
                void this.emitEvent(types_1.AuthorizationEvents.ON_AUTH_REQUEST_VERIFIED_SUCCESS, {
                    correlationId,
                    subject: verifiedAuthorizationRequest.authorizationRequest,
                });
                return verifiedAuthorizationRequest;
            })
                .catch((error) => {
                void this.emitEvent(types_1.AuthorizationEvents.ON_AUTH_REQUEST_VERIFIED_FAILED, {
                    correlationId,
                    subject: authorizationRequest,
                    error,
                });
                throw error;
            });
        });
    }
    createAuthorizationResponse(verifiedAuthorizationRequest, responseOpts) {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            if (verifiedAuthorizationRequest.correlationId &&
                (responseOpts === null || responseOpts === void 0 ? void 0 : responseOpts.correlationId) &&
                verifiedAuthorizationRequest.correlationId !== responseOpts.correlationId) {
                throw new Error(`Request correlation id ${verifiedAuthorizationRequest.correlationId} is different from option correlation id ${responseOpts.correlationId}`);
            }
            let version = responseOpts === null || responseOpts === void 0 ? void 0 : responseOpts.version;
            const rpSupportedVersions = (0, SIOPSpecVersion_1.authorizationRequestVersionDiscovery)(yield verifiedAuthorizationRequest.authorizationRequest.mergedPayloads());
            if (version && rpSupportedVersions.length > 0 && !rpSupportedVersions.includes(version)) {
                throw Error(`RP does not support spec version ${version}, supported versions: ${rpSupportedVersions.toString()}`);
            }
            else if (!version) {
                version = rpSupportedVersions.reduce((previous, current) => (current.valueOf() > previous.valueOf() ? current : previous), types_1.SupportedVersion.SIOPv2_ID1);
            }
            const correlationId = (responseOpts === null || responseOpts === void 0 ? void 0 : responseOpts.correlationId) || verifiedAuthorizationRequest.correlationId || (0, uuid_1.v4)();
            try {
                // IF using DIRECT_POST, the response_uri takes precedence over the redirect_uri
                let responseUri = verifiedAuthorizationRequest.responseURI;
                if (verifiedAuthorizationRequest.authorizationRequestPayload.response_mode === types_1.ResponseMode.DIRECT_POST) {
                    responseUri = (_a = verifiedAuthorizationRequest.authorizationRequestPayload.response_uri) !== null && _a !== void 0 ? _a : responseUri;
                }
                const response = yield authorization_response_1.AuthorizationResponse.fromVerifiedAuthorizationRequest(verifiedAuthorizationRequest, this.newAuthorizationResponseOpts(Object.assign(Object.assign({}, responseOpts), { version,
                    correlationId })), verifiedAuthorizationRequest.verifyOpts);
                void this.emitEvent(types_1.AuthorizationEvents.ON_AUTH_RESPONSE_CREATE_SUCCESS, {
                    correlationId,
                    subject: response,
                });
                return { correlationId, response, responseURI: responseUri };
            }
            catch (error) {
                void this.emitEvent(types_1.AuthorizationEvents.ON_AUTH_RESPONSE_CREATE_FAILED, {
                    correlationId,
                    subject: verifiedAuthorizationRequest.authorizationRequest,
                    error,
                });
                throw error;
            }
        });
    }
    // TODO SK Can you please put some documentation on it?
    submitAuthorizationResponse(authorizationResponse) {
        var _a, _b, _c;
        return __awaiter(this, void 0, void 0, function* () {
            const { correlationId, response } = authorizationResponse;
            if (!correlationId) {
                throw Error('No correlation Id provided');
            }
            if (!response ||
                (((_a = response.options) === null || _a === void 0 ? void 0 : _a.responseMode) &&
                    !(response.options.responseMode === types_1.ResponseMode.POST ||
                        response.options.responseMode === types_1.ResponseMode.FORM_POST ||
                        response.options.responseMode === types_1.ResponseMode.DIRECT_POST))) {
                throw new Error(types_1.SIOPErrors.BAD_PARAMS);
            }
            const payload = response.payload;
            const idToken = yield ((_b = response.idToken) === null || _b === void 0 ? void 0 : _b.payload());
            const responseUri = (_c = authorizationResponse.responseURI) !== null && _c !== void 0 ? _c : idToken === null || idToken === void 0 ? void 0 : idToken.aud;
            if (!responseUri) {
                throw Error('No response URI present');
            }
            const authResponseAsURI = (0, helpers_1.encodeJsonAsURI)(payload, { arraysWithIndex: ['presentation_submission', 'vp_token'] });
            return (0, helpers_1.post)(responseUri, authResponseAsURI, { contentType: types_1.ContentType.FORM_URL_ENCODED })
                .then((result) => {
                void this.emitEvent(types_1.AuthorizationEvents.ON_AUTH_RESPONSE_SENT_SUCCESS, { correlationId, subject: response });
                return result.origResponse;
            })
                .catch((error) => {
                void this.emitEvent(types_1.AuthorizationEvents.ON_AUTH_RESPONSE_SENT_FAILED, { correlationId, subject: response, error });
                throw error;
            });
        });
    }
    /**
     * Create an Authentication Request Payload from a URI string
     *
     * @param encodedUri
     */
    parseAuthorizationRequestURI(encodedUri) {
        return __awaiter(this, void 0, void 0, function* () {
            const { scheme, requestObjectJwt, authorizationRequestPayload, registrationMetadata } = yield authorization_request_1.URI.parseAndResolve(encodedUri);
            return {
                encodedUri,
                encodingFormat: types_1.UrlEncodingFormat.FORM_URL_ENCODED,
                scheme: scheme,
                requestObjectJwt,
                authorizationRequestPayload,
                registration: registrationMetadata,
            };
        });
    }
    newAuthorizationResponseOpts(opts) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j;
        const version = (_a = opts.version) !== null && _a !== void 0 ? _a : this._createResponseOptions.version;
        let issuer = (_b = opts.issuer) !== null && _b !== void 0 ? _b : (_d = (_c = this._createResponseOptions) === null || _c === void 0 ? void 0 : _c.registration) === null || _d === void 0 ? void 0 : _d.issuer;
        if (version === types_1.SupportedVersion.JWT_VC_PRESENTATION_PROFILE_v1) {
            issuer = types_1.ResponseIss.JWT_VC_PRESENTATION_V1;
        }
        else if (version === types_1.SupportedVersion.SIOPv2_ID1) {
            issuer = types_1.ResponseIss.SELF_ISSUED_V2;
        }
        if (!issuer) {
            throw Error(`No issuer value present. Either use IDv1, JWT VC Presentation profile version, or provide a DID as issuer value`);
        }
        // We are taking the whole presentationExchange object from a certain location
        const presentationExchange = (_e = opts.presentationExchange) !== null && _e !== void 0 ? _e : this._createResponseOptions.presentationExchange;
        const responseURI = (_f = opts.audience) !== null && _f !== void 0 ? _f : this._createResponseOptions.responseURI;
        return Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({}, this._createResponseOptions), opts), { signature: Object.assign(Object.assign({}, (_g = this._createResponseOptions) === null || _g === void 0 ? void 0 : _g.signature), opts.signature) }), (presentationExchange && { presentationExchange })), { registration: Object.assign(Object.assign({}, (_h = this._createResponseOptions) === null || _h === void 0 ? void 0 : _h.registration), { issuer }), responseURI, responseURIType: (_j = this._createResponseOptions.responseURIType) !== null && _j !== void 0 ? _j : (version < types_1.SupportedVersion.SIOPv2_D12_OID4VP_D18 && responseURI ? 'redirect_uri' : undefined) });
    }
    newVerifyAuthorizationRequestOpts(requestOpts) {
        const verification = Object.assign(Object.assign(Object.assign({}, this._verifyRequestOptions), requestOpts), { verification: (0, Opts_1.mergeVerificationOpts)(this._verifyRequestOptions, requestOpts), correlationId: requestOpts.correlationId });
        return verification;
    }
    emitEvent(type, payload) {
        return __awaiter(this, void 0, void 0, function* () {
            if (this._eventEmitter) {
                this._eventEmitter.emit(type, new types_1.AuthorizationEvent(payload));
            }
        });
    }
    addEventListener(register) {
        if (!this._eventEmitter) {
            throw Error('Cannot add listeners if no event emitter is available');
        }
        const events = Array.isArray(register.event) ? register.event : [register.event];
        for (const event of events) {
            this._eventEmitter.addListener(event, register.listener);
        }
    }
    static fromOpts(responseOpts, verifyOpts) {
        return new OP({ responseOpts, verifyOpts });
    }
    static builder() {
        return new OPBuilder_1.OPBuilder();
    }
    get createResponseOptions() {
        return this._createResponseOptions;
    }
    get verifyRequestOptions() {
        return this._verifyRequestOptions;
    }
}
exports.OP = OP;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1AuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvb3AvT1AudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBR0EsK0JBQW9DO0FBRXBDLG9FQUFxRztBQUNyRyx3REFBc0U7QUFDdEUsc0VBS21DO0FBQ25DLHdDQUFtRDtBQUNuRCxnRUFBa0Y7QUFDbEYsb0NBa0JrQjtBQUVsQiwyQ0FBd0M7QUFDeEMsaUNBQXVIO0FBRXZILDZJQUE2STtBQUM3SSxNQUFhLEVBQUU7SUFLYixZQUFvQixJQUFvSDs7UUFDdEksSUFBSSxDQUFDLHNCQUFzQixxQkFBUSxJQUFBLGtEQUEyQyxFQUFDLElBQUksQ0FBQyxDQUFFLENBQUM7UUFDdkYsSUFBSSxDQUFDLHFCQUFxQixxQkFBUSxJQUFBLHVEQUFnRCxFQUFDLElBQUksQ0FBQyxDQUFFLENBQUM7UUFDM0YsSUFBSSxDQUFDLGFBQWEsR0FBRyxNQUFBLElBQUksQ0FBQyxPQUFPLDBDQUFFLFlBQVksQ0FBQztJQUNsRCxDQUFDO0lBRUQ7Ozs7OztPQU1HO0lBRVUsMEJBQTBCLENBQ3JDLGVBQTZCLEVBQzdCLFdBQW9HOztZQUVwRyxNQUFNLGFBQWEsR0FBRyxDQUFBLFdBQVcsYUFBWCxXQUFXLHVCQUFYLFdBQVcsQ0FBRSxhQUFhLEtBQUksSUFBQSxTQUFNLEdBQUUsQ0FBQztZQUM3RCxNQUFNLG9CQUFvQixHQUFHLE1BQU0sNENBQW9CLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQztpQkFDbEYsSUFBSSxDQUFDLENBQUMsTUFBNEIsRUFBRSxFQUFFO2dCQUNyQyxLQUFLLElBQUksQ0FBQyxTQUFTLENBQUMsMkJBQW1CLENBQUMsZ0NBQWdDLEVBQUUsRUFBRSxhQUFhLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7Z0JBQzlHLE9BQU8sTUFBTSxDQUFDO1lBQ2hCLENBQUMsQ0FBQztpQkFDRCxLQUFLLENBQUMsQ0FBQyxLQUFZLEVBQUUsRUFBRTtnQkFDdEIs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