"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.PresentationExchange = void 0;
const pex_1 = require("@sphereon/pex");
const ssi_types_1 = require("@sphereon/ssi-types");
const helpers_1 = require("../helpers");
const types_1 = require("../types");
const types_2 = require("./types");
class PresentationExchange {
    constructor(opts) {
        this.pex = new pex_1.PEX();
        this.allDIDs = opts.allDIDs;
        this.allVerifiableCredentials = opts.allVerifiableCredentials;
    }
    /**
     * Construct presentation submission from selected credentials
     * @param presentationDefinition payload object received by the OP from the RP
     * @param selectedCredentials
     * @param presentationSignCallback
     * @param options
     */
    createVerifiablePresentation(presentationDefinition, selectedCredentials, presentationSignCallback, 
    // options2?: { nonce?: string; domain?: string, proofType?: IProofType, verificationMethod?: string, signatureKeyEncoding?: KeyEncoding },
    options) {
        var _a, _b, _c, _d, _e, _f;
        return __awaiter(this, void 0, void 0, function* () {
            if (!presentationDefinition) {
                throw new Error(types_1.SIOPErrors.REQUEST_CLAIMS_PRESENTATION_DEFINITION_NOT_VALID);
            }
            const signOptions = Object.assign(Object.assign({}, options), { presentationSubmissionLocation: pex_1.PresentationSubmissionLocation.EXTERNAL, proofOptions: Object.assign(Object.assign({}, options.proofOptions), { proofPurpose: (_b = (_a = options === null || options === void 0 ? void 0 : options.proofOptions) === null || _a === void 0 ? void 0 : _a.proofPurpose) !== null && _b !== void 0 ? _b : ssi_types_1.IProofPurpose.authentication, type: (_d = (_c = options === null || options === void 0 ? void 0 : options.proofOptions) === null || _c === void 0 ? void 0 : _c.type) !== null && _d !== void 0 ? _d : ssi_types_1.IProofType.EcdsaSecp256k1Signature2019 }), signatureOptions: Object.assign(Object.assign({}, options.signatureOptions), { 
                    // verificationMethod: options?.signatureOptions?.verificationMethod,
                    keyEncoding: (_f = (_e = options === null || options === void 0 ? void 0 : options.signatureOptions) === null || _e === void 0 ? void 0 : _e.keyEncoding) !== null && _f !== void 0 ? _f : pex_1.KeyEncoding.Hex }) });
            return yield this.pex.verifiablePresentationFrom(presentationDefinition, selectedCredentials, presentationSignCallback, signOptions);
        });
    }
    /**
     * This method will be called from the OP when we are certain that we have a
     * PresentationDefinition object inside our requestPayload
     * Finds a set of `VerifiableCredential`s from a list supplied to this class during construction,
     * matching presentationDefinition object found in the requestPayload
     * if requestPayload doesn't contain any valid presentationDefinition throws an error
     * if PEX library returns any error in the process, throws the error
     * returns the SelectResults object if successful
     * @param presentationDefinition object received by the OP from the RP
     * @param opts
     */
    selectVerifiableCredentialsForSubmission(presentationDefinition, opts) {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            if (!presentationDefinition) {
                throw new Error(types_1.SIOPErrors.REQUEST_CLAIMS_PRESENTATION_DEFINITION_NOT_VALID);
            }
            else if (!this.allVerifiableCredentials || this.allVerifiableCredentials.length == 0) {
                throw new Error(`${types_1.SIOPErrors.COULD_NOT_FIND_VCS_MATCHING_PD}, no VCs were provided`);
            }
            const selectResults = this.pex.selectFrom(presentationDefinition, this.allVerifiableCredentials, Object.assign(Object.assign({}, opts), { holderDIDs: (_a = opts === null || opts === void 0 ? void 0 : opts.holderDIDs) !== null && _a !== void 0 ? _a : this.allDIDs, 
                // fixme limited disclosure
                limitDisclosureSignatureSuites: [] }));
            if (selectResults.areRequiredCredentialsPresent === pex_1.Status.ERROR) {
                throw new Error(`message: ${types_1.SIOPErrors.COULD_NOT_FIND_VCS_MATCHING_PD}, details: ${JSON.stringify(selectResults.errors)}`);
            }
            return selectResults;
        });
    }
    /**
     * validatePresentationAgainstDefinition function is called mainly by the RP
     * after receiving the VP from the OP
     * @param presentationDefinition object containing PD
     * @param verifiablePresentation
     * @param opts
     */
    static validatePresentationAgainstDefinition(presentationDefinition, verifiablePresentation, opts) {
        return __awaiter(this, void 0, void 0, function* () {
            const wvp = typeof verifiablePresentation === 'object' && 'original' in verifiablePresentation
                ? verifiablePresentation
                : ssi_types_1.CredentialMapper.toWrappedVerifiablePresentation(verifiablePresentation);
            if (!presentationDefinition) {
                throw new Error(types_1.SIOPErrors.REQUEST_CLAIMS_PRESENTATION_DEFINITION_NOT_VALID);
            }
            else if (!wvp || !wvp.presentation || !wvp.presentation.verifiableCredential || wvp.presentation.verifiableCredential.length === 0) {
                throw new Error(types_1.SIOPErrors.NO_VERIFIABLE_PRESENTATION_NO_CREDENTIALS);
            }
            // console.log(`Presentation (validate): ${JSON.stringify(verifiablePresentation)}`);
            const evaluationResults = new pex_1.PEX().evaluatePresentation(presentationDefinition, wvp.original, opts);
            if (evaluationResults.errors.length) {
                throw new Error(`message: ${types_1.SIOPErrors.COULD_NOT_FIND_VCS_MATCHING_PD}, details: ${JSON.stringify(evaluationResults.errors)}`);
            }
            return evaluationResults;
        });
    }
    static assertValidPresentationSubmission(presentationSubmission) {
        const validationResult = pex_1.PEX.validateSubmission(presentationSubmission);
        if (validationResult[0].message != 'ok') {
            throw new Error(`${types_1.SIOPErrors.RESPONSE_OPTS_PRESENTATIONS_SUBMISSION_IS_NOT_VALID}, details ${JSON.stringify(validationResult[0])}`);
        }
    }
    /**
     * Finds a valid PresentationDefinition inside the given AuthenticationRequestPayload
     * throws exception if the PresentationDefinition is not valid
     * returns null if no property named "presentation_definition" is found
     * returns a PresentationDefinition if a valid instance found
     * @param authorizationRequestPayload object that can have a presentation_definition inside
     * @param version
     */
    static findValidPresentationDefinitions(authorizationRequestPayload, version) {
        return __awaiter(this, void 0, void 0, function* () {
            const allDefinitions = [];
            function extractDefinitionFromVPToken() {
                return __awaiter(this, void 0, void 0, function* () {
                    const vpTokens = (0, helpers_1.extractDataFromPath)(authorizationRequestPayload, '$..vp_token.presentation_definition').map((d) => d.value);
                    const vpTokenRefs = (0, helpers_1.extractDataFromPath)(authorizationRequestPayload, '$..vp_token.presentation_definition_uri');
                    if (vpTokens && vpTokens.length && vpTokenRefs && vpTokenRefs.length) {
                        throw new Error(types_1.SIOPErrors.REQUEST_CLAIMS_PRESENTATION_DEFINITION_BY_REF_AND_VALUE_NON_EXCLUSIVE);
                    }
                    if (vpTokens && vpTokens.length) {
                        vpTokens.forEach((vpToken) => {
                            if (allDefinitions.find((value) => value.definition.id === vpToken.id)) {
                                console.log(`Warning. We encountered presentation definition with id ${vpToken.id}, more then once whilst processing! Make sure your payload is valid!`);
                                return;
                            }
                            PresentationExchange.assertValidPresentationDefinition(vpToken);
                            allDefinitions.push({
                                definition: vpToken,
                                location: types_2.PresentationDefinitionLocation.CLAIMS_VP_TOKEN,
                                version,
                            });
                        });
                    }
                    else if (vpTokenRefs && vpTokenRefs.length) {
                        for (const vpTokenRef of vpTokenRefs) {
                            const pd = (yield (0, helpers_1.getWithUrl)(vpTokenRef.value));
                            if (allDefinitions.find((value) => value.definition.id === pd.id)) {
                                console.log(`Warning. We encountered presentation definition with id ${pd.id}, more then once whilst processing! Make sure your payload is valid!`);
                                return;
                            }
                            PresentationExchange.assertValidPresentationDefinition(pd);
                            allDefinitions.push({ definition: pd, location: types_2.PresentationDefinitionLocation.CLAIMS_VP_TOKEN, version });
                        }
                    }
                });
            }
            function addSingleToplevelPDToPDs(definition, version) {
                if (allDefinitions.find((value) => value.definition.id === definition.id)) {
                    console.log(`Warning. We encountered presentation definition with id ${definition.id}, more then once whilst processing! Make sure your payload is valid!`);
                    return;
                }
                PresentationExchange.assertValidPresentationDefinition(definition);
                allDefinitions.push({
                    definition,
                    location: types_2.PresentationDefinitionLocation.TOPLEVEL_PRESENTATION_DEF,
                    version,
                });
            }
            function extractDefinitionFromTopLevelDefinitionProperty(version) {
                return __awaiter(this, void 0, void 0, function* () {
                    const definitions = (0, helpers_1.extractDataFromPath)(authorizationRequestPayload, '$.presentation_definition');
                    const definitionsFromList = (0, helpers_1.extractDataFromPath)(authorizationRequestPayload, '$.presentation_definition[*]');
                    const definitionRefs = (0, helpers_1.extractDataFromPath)(authorizationRequestPayload, '$.presentation_definition_uri');
                    const definitionRefsFromList = (0, helpers_1.extractDataFromPath)(authorizationRequestPayload, '$.presentation_definition_uri[*]');
                    const hasPD = (definitions && definitions.length > 0) || (definitionsFromList && definitionsFromList.length > 0);
                    const hasPdRef = (definitionRefs && definitionRefs.length > 0) || (definitionRefsFromList && definitionsFromList.length > 0);
                    if (hasPD && hasPdRef) {
                        throw new Error(types_1.SIOPErrors.REQUEST_CLAIMS_PRESENTATION_DEFINITION_BY_REF_AND_VALUE_NON_EXCLUSIVE);
                    }
                    if (definitions && definitions.length > 0) {
                        definitions.forEach((definition) => {
                            addSingleToplevelPDToPDs(definition.value, version);
                        });
                    }
                    else if (definitionsFromList && definitionsFromList.length > 0) {
                        definitionsFromList.forEach((definition) => {
                            addSingleToplevelPDToPDs(definition.value, version);
                        });
                    }
                    else if (definitionRefs && definitionRefs.length > 0) {
                        for (const definitionRef of definitionRefs) {
                            const pd = yield (0, helpers_1.getWithUrl)(definitionRef.value);
                            addSingleToplevelPDToPDs(pd, version);
                        }
                    }
                    else if (definitionsFromList && definitionRefsFromList.length > 0) {
                        for (const definitionRef of definitionRefsFromList) {
                            const pd = yield (0, helpers_1.getWithUrl)(definitionRef.value);
                            addSingleToplevelPDToPDs(pd, version);
                        }
                    }
                });
            }
            if (authorizationRequestPayload) {
                if (!version || version < types_1.SupportedVersion.SIOPv2_D11) {
                    yield extractDefinitionFromVPToken();
                }
                yield extractDefinitionFromTopLevelDefinitionProperty();
            }
            return allDefinitions;
        });
    }
    static assertValidPresentationDefinitionWithLocations(definitionsWithLocations) {
        if (definitionsWithLocations && definitionsWithLocations.length > 0) {
            definitionsWithLocations.forEach((definitionWithLocation) => PresentationExchange.assertValidPresentationDefinition(definitionWithLocation.definition));
        }
    }
    static assertValidPresentationDefinition(presentationDefinition) {
        const validationResult = pex_1.PEX.validateDefinition(presentationDefinition);
        if (validationResult[0].message != 'ok') {
            throw new Error(`${types_1.SIOPErrors.REQUEST_CLAIMS_PRESENTATION_DEFINITION_NOT_VALID}`);
        }
    }
    static validatePresentationsAgainstDefinitions(definitions, vpPayloads, verifyPresentationCallback, opts) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!definitions || !vpPayloads || !definitions.length || definitions.length !== vpPayloads.length) {
                throw new Error(types_1.SIOPErrors.COULD_NOT_FIND_VCS_MATCHING_PD);
            }
            yield Promise.all(definitions.map((pd) => __awaiter(this, void 0, void 0, function* () { return yield PresentationExchange.validatePresentationsAgainstDefinition(pd.definition, vpPayloads, verifyPresentationCallback, opts); })));
        });
    }
    static validatePresentationsAgainstDefinition(definition, vpPayloads, verifyPresentationCallback, opts) {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            const pex = new pex_1.PEX();
            function filterOutCorrectPresentation() {
                //TODO: add support for multiple VPs here
                return vpPayloads.filter((vpw) => __awaiter(this, void 0, void 0, function* () {
                    var _a;
                    const presentationSubmission = (_a = opts === null || opts === void 0 ? void 0 : opts.presentationSubmission) !== null && _a !== void 0 ? _a : vpw.presentation.presentation_submission;
                    const presentation = vpw.presentation;
                    if (!definition) {
                        throw new Error(types_1.SIOPErrors.NO_PRESENTATION_SUBMISSION);
                    }
                    else if (!presentation || !presentation.verifiableCredential || presentation.verifiableCredential.length === 0) {
                        throw new Error(types_1.SIOPErrors.NO_VERIFIABLE_PRESENTATION_NO_CREDENTIALS);
                    }
                    // The verifyPresentationCallback function is mandatory for RP only,
                    // So the behavior here is to bypass it if not present
                    if (verifyPresentationCallback) {
                        try {
                            yield verifyPresentationCallback(vpw.original, presentationSubmission);
                        }
                        catch (error) {
                            throw new Error(types_1.SIOPErrors.VERIFIABLE_PRESENTATION_SIGNATURE_NOT_VALID);
                        }
                    }
                    // console.log(`Presentation (filter): ${JSON.stringify(presentation)}`);
                    const evaluationResults = pex.evaluatePresentation(definition, vpw.original, Object.assign(Object.assign({}, opts), { presentationSubmission }));
                    const submission = evaluationResults.value;
                    if (!presentation || !submission) {
                        throw new Error(types_1.SIOPErrors.NO_PRESENTATION_SUBMISSION);
                    }
                    return submission && submission.definition_id === definition.id;
                }));
            }
            const checkedPresentations = filterOutCorrectPresentation();
            if (checkedPresentations.length !== 1) {
                throw new Error(`${types_1.SIOPErrors.COULD_NOT_FIND_VCS_MATCHING_PD}`);
            }
            const checkedPresentation = checkedPresentations[0];
            const presentation = checkedPresentation.presentation;
            // console.log(`Presentation (checked): ${JSON.stringify(checkedPresentation.presentation)}`);
            if (!presentation || !presentation.verifiableCredential || presentation.verifiableCredential.length === 0) {
                throw new Error(types_1.SIOPErrors.NO_VERIFIABLE_PRESENTATION_NO_CREDENTIALS);
            }
            const presentationSubmission = (_a = opts === null || opts === void 0 ? void 0 : opts.presentationSubmission) !== null && _a !== void 0 ? _a : presentation.presentation_submission;
            const evaluationResults = pex.evaluatePresentation(definition, checkedPresentation.original, Object.assign(Object.assign({}, opts), { presentationSubmission }));
            PresentationExchange.assertValidPresentationSubmission(evaluationResults.value);
            yield PresentationExchange.validatePresentationAgainstDefinition(definition, checkedPresentation, Object.assign(Object.assign({}, opts), { presentationSubmission }));
        });
    }
}
exports.PresentationExchange = PresentationExchange;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUHJlc2VudGF0aW9uRXhjaGFuZ2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYXV0aG9yaXphdGlvbi1yZXNwb25zZS9QcmVzZW50YXRpb25FeGNoYW5nZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQSx1Q0FVdUI7QUFFdkIsbURBUzZCO0FBRTdCLHdDQUE2RDtBQUM3RCxvQ0FBcUY7QUFFckYsbUNBS2lCO0FBRWpCLE1BQWEsb0JBQW9CO0lBSy9CLFlBQVksSUFBaUY7UUFKcEYsUUFBRyxHQUFHLElBQUksU0FBRyxFQUFFLENBQUM7UUFLdkIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBQzVCLElBQUksQ0FBQyx3QkFBd0IsR0FBRyxJQUFJLENBQUMsd0JBQXdCLENBQUM7SUFDaEUsQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNVLDRCQUE0QixDQUN2QyxzQkFBK0MsRUFDL0MsbUJBQThDLEVBQzlDLHdCQUFrRDtJQUNsRCwySUFBMkk7SUFDM0ksT0FBd0M7OztZQUV4QyxJQUFJLENBQUMsc0JBQXNCLEVBQUU7Z0JBQzNCLE1BQU0sSUFBSSxLQUFLLENBQUMsa0JBQVUsQ0FBQyxnREFBZ0QsQ0FBQyxDQUFDO2FBQzlFO1lBRUQsTUFBTSxXQUFXLG1DQUNaLE9BQU8sS0FDViw4QkFBOEIsRUFBRSxvQ0FBOEIsQ0FBQyxRQUFRLEVBQ3ZFLFlBQVksa0NBQ1AsT0FBTyxDQUFDLFlBQVksS0FDdkIsWUFBWSxFQUFFLE1BQUEsTUFBQSxPQUFPLGFBQVAsT0FBTyx1QkFBUCxPQUFPLENBQUUsWUFBWSwwQ0FBRSxZQUFZLG1DQUFJLHlCQUFhLENBQUMsY0FBYyxFQUNqRixJQUFJLEVBQUUsTUFBQSxNQUFBLE9BQU8sYUFBUCxPQUFPLHVCQUFQLE9BQU8sQ0FBRSxZQUFZLDBDQUFFLElBQUksbUNBQUksc0JBQVUsQ0FBQywyQkFBMkIsS0FJN0UsZ0JBQWdCLGtDQUNYLE9BQU8s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