"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.resolveDidDocument = exports.mergeAllDidMethods = exports.getResolverUnion = exports.getResolver = void 0;
const did_uni_client_1 = require("@sphereon/did-uni-client");
const did_resolver_1 = require("did-resolver");
const types_1 = require("../types");
const index_1 = require("./index");
function getResolver(opts) {
    if (opts && typeof opts.resolver === 'object') {
        return opts.resolver;
    }
    if (!opts || !opts.subjectSyntaxTypesSupported) {
        if (opts === null || opts === void 0 ? void 0 : opts.noUniversalResolverFallback) {
            throw Error(`No subject syntax types nor did methods configured for DID resolution, but fallback to universal resolver has been disabled`);
        }
        console.log(`Falling back to universal resolver as no resolve opts have been provided, or no subject syntax types supported are provided. It is wise to fix this`);
        return new did_uni_client_1.UniResolver();
    }
    const uniResolvers = [];
    if (opts.subjectSyntaxTypesSupported.indexOf(types_1.SubjectIdentifierType.DID) === -1) {
        const specificDidMethods = opts.subjectSyntaxTypesSupported.filter((sst) => sst.includes('did:'));
        if (!specificDidMethods.length) {
            throw new Error(types_1.SIOPErrors.NO_DID_METHOD_FOUND);
        }
        for (const didMethod of specificDidMethods) {
            const uniResolver = (0, did_uni_client_1.getUniResolver)((0, index_1.getMethodFromDid)(didMethod), { resolveUrl: opts.resolveUrl });
            uniResolvers.push(uniResolver);
        }
        return new did_resolver_1.Resolver(...uniResolvers);
    }
    else {
        if (opts === null || opts === void 0 ? void 0 : opts.noUniversalResolverFallback) {
            throw Error(`No subject syntax types nor did methods configured for DID resolution, but fallback to universal resolver has been disabled`);
        }
        console.log(`Falling back to universal resolver as no resolve opts have been provided, or no subject syntax types supported are provided. It is wise to fix this`);
        return new did_uni_client_1.UniResolver();
    }
}
exports.getResolver = getResolver;
/**
 * This method returns a resolver object in OP/RP
 * If the user of this library, configures OP/RP to have a customResolver, we will use that
 * If the user of this library configures OP/RP to use a custom resolver for any specific did method, we will use that
 * and in the end for the rest of the did methods, configured either with calling `addDidMethod` upon building OP/RP
 * (without any resolver configuration) or declaring in the subject_syntax_types_supported of the registration object
 * we will use universal resolver from Sphereon's DID Universal Resolver library
 * @param customResolver
 * @param subjectSyntaxTypesSupported
 * @param resolverMap
 */
function getResolverUnion(customResolver, subjectSyntaxTypesSupported, resolverMap) {
    if (customResolver) {
        return customResolver;
    }
    const fallbackResolver = customResolver ? customResolver : new did_uni_client_1.UniResolver();
    const uniResolvers = [];
    const subjectTypes = [];
    if (subjectSyntaxTypesSupported) {
        typeof subjectSyntaxTypesSupported === 'string'
            ? subjectTypes.push(subjectSyntaxTypesSupported)
            : subjectTypes.push(...subjectSyntaxTypesSupported);
    }
    if (subjectTypes.indexOf(types_1.SubjectSyntaxTypesSupportedValues.DID.valueOf()) !== -1) {
        return customResolver ? customResolver : new did_uni_client_1.UniResolver();
    }
    const specificDidMethods = subjectTypes.filter((sst) => !!sst && sst.startsWith('did:'));
    specificDidMethods.forEach((dm) => {
        let methodResolver;
        if (!resolverMap.has(dm) || resolverMap.get(dm) === null) {
            methodResolver = (0, did_uni_client_1.getUniResolver)((0, index_1.getMethodFromDid)(dm));
        }
        else {
            methodResolver = resolverMap.get(dm);
        }
        uniResolvers.push(methodResolver);
    });
    return subjectTypes.indexOf(types_1.SubjectSyntaxTypesSupportedValues.DID.valueOf()) !== -1
        ? new did_resolver_1.Resolver(...Object.assign({ fallbackResolver }, uniResolvers))
        : new did_resolver_1.Resolver(...uniResolvers);
}
exports.getResolverUnion = getResolverUnion;
function mergeAllDidMethods(subjectSyntaxTypesSupported, resolvers) {
    if (!Array.isArray(subjectSyntaxTypesSupported)) {
        subjectSyntaxTypesSupported = [subjectSyntaxTypesSupported];
    }
    const unionSubjectSyntaxTypes = new Set();
    subjectSyntaxTypesSupported.forEach((sst) => unionSubjectSyntaxTypes.add(sst));
    resolvers.forEach((_, didMethod) => unionSubjectSyntaxTypes.add((0, index_1.toSIOPRegistrationDidMethod)(didMethod)));
    return Array.from(unionSubjectSyntaxTypes);
}
exports.mergeAllDidMethods = mergeAllDidMethods;
function resolveDidDocument(did, opts) {
    var _a;
    return __awaiter(this, void 0, void 0, function* () {
        // todo: The accept is only there because did:key used by Veramo requires it. According to the spec it is optional. It should not hurt, but let's test
        const result = yield getResolver(Object.assign({}, opts)).resolve(did, { accept: 'application/did+ld+json' });
        if ((_a = result === null || result === void 0 ? void 0 : result.didResolutionMetadata) === null || _a === void 0 ? void 0 : _a.error) {
            throw Error(result.didResolutionMetadata.error);
        }
        // eslint-disable-next-line @typescript-eslint/ban-ts-comment
        // @ts-ignore
        if (!result.didDocument && result.id) {
            // todo: This looks like a bug. It seems that sometimes we get back a DID document directly instead of a did resolution results
            return result;
        }
        return result.didDocument;
    });
}
exports.resolveDidDocument = resolveDidDocument;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRElEUmVzb2x1dGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9kaWQvRElEUmVzb2x1dGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQSw2REFBdUU7QUFDdkUsK0NBQTBHO0FBRTFHLG9DQUEwSDtBQUUxSCxtQ0FBd0U7QUFFeEUsU0FBZ0IsV0FBVyxDQUFDLElBQWlCO0lBQzNDLElBQUksSUFBSSxJQUFJLE9BQU8sSUFBSSxDQUFDLFFBQVEsS0FBSyxRQUFRLEVBQUU7UUFDN0MsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDO0tBQ3RCO0lBQ0QsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQywyQkFBMkIsRUFBRTtRQUM5QyxJQUFJLElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSwyQkFBMkIsRUFBRTtZQUNyQyxNQUFNLEtBQUssQ0FBQyw2SEFBNkgsQ0FBQyxDQUFDO1NBQzVJO1FBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FDVCxxSkFBcUosQ0FDdEosQ0FBQztRQUNGLE9BQU8sSUFBSSw0QkFBVyxFQUFFLENBQUM7S0FDMUI7SUFFRCxNQUFNLFlBQVksR0FFWixFQUFFLENBQUM7SUFDVCxJQUFJLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxPQUFPLENBQUMsNkJBQXFCLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7UUFDOUUsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLENBQUMsMkJBQTJCLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDbEcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sRUFBRTtZQUM5QixNQUFNLElBQUksS0FBSyxDQUFDLGtCQUFVLENBQUMsbUJBQW1CLENBQUMsQ0FBQztTQUNqRDtRQUNELEtBQUssTUFBTSxTQUFTLElBQUksa0JBQWtCLEVBQUU7WUFDMUMsTUFBTSxXQUFXLEdBQUcsSUFBQSwrQkFBYyxFQUFDLElBQUEsd0JBQWdCLEVBQUMsU0FBUyxDQUFDLEVBQUUsRUFBRSxVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7WUFDakcsWUFBWSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztTQUNoQztRQUNELE9BQU8sSUFBSSx1QkFBUSxDQUFDLEdBQUcsWUFBWSxDQUFDLENBQUM7S0FDdEM7U0FBTTtRQUNMLElBQUksSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLDJCQUEyQixFQUFFO1lBQ3JDLE1BQU0sS0FBSyxDQUFDLDZIQUE2SCxDQUFDLENBQUM7U0FDNUk7UUFDRCxPQUFPLENBQUMsR0FBRyxDQUNULHFKQUFxSixDQUN0SixDQUFDO1FBQ0YsT0FBTyxJQUFJLDRCQUFXLEVBQUUsQ0FBQztLQUMxQjtBQUNILENBQUM7QUFwQ0Qsa0NBb0NDO0FBRUQ7Ozs7Ozs7Ozs7R0FVRztBQUNILFNBQWdCLGdCQUFnQixDQUM5QixjQUEwQixFQUMxQiwyQkFBOEMsRUFDOUMsV0FBb0M7SUFFcEMsSUFBSSxjQUFjLEVBQUU7UUFDbEIsT0FBTyxjQUFjLENBQUM7S0FDdkI7SUFDRCxNQUFNLGdCQUFnQixHQUFlLGNBQWMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxJQUFJLDRCQUFXLEVBQUUsQ0FBQztJQUN6RixNQUFNLFlBQVksR0FFWixFQUFFLENBQUM7SUFDVCxNQUFNLFlBQVksR0FBYSxFQUFFLENBQUM7SUFDbEMsSUFBSSwyQkFBMkIsRUFBRTtRQUMvQixPQUFPLDJCQUEyQixLQUFLLFFBQVE7WUFDN0MsQ0FBQyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsMkJBQTJCLENBQUM7WUFDaEQsQ0FBQyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRywyQkFBMkIsQ0FBQyxDQUFDO0tBQ3ZEO0lBQ0QsSUFBSSxZQUFZLENBQUMsT0FBTyxDQUFDLHlDQUFpQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFO1FBQ2hGLE9BQU8sY0FBYyxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLElBQUksNEJBQVcsRUFBRSxDQUFDO0tBQzVEO0lBQ0QsTUFBTSxrQkFBa0IsR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUN6RixrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRTtRQUNoQyxJQUFJLGNBQWMsQ0FBQztRQUNuQixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxXQUFXLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxLQUFLLElBQUksRUFBRTtZQUN4RCxjQUFjLEdBQUcsSUFBQSwrQkFBYyxFQUFDLElBQUEsd0JBQWdCLEVBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUN2RDthQUFNO1lBQ0wsY0FBYyxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDdEM7UUFDRCxZQUFZLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQ3BDLENBQUMsQ0FBQyxDQUFDO0lBQ0gsT0FBTyxZQUFZLENBQUMsT0FBTyxDQUFDLHlDQUFpQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNqRixDQUFDLENBQUMsSUFBSSx1QkFBUSxDQUFDLG1CQUFLLGdCQUFnQixJQUFLLFlBQVksQ0FBRSxDQUFDO1FBQ3hELENBQUMsQ0FBQyxJQUFJLHVCQUFRLENBQUMsR0FBRyxZQUFZLENBQUMsQ0FBQztBQUNwQyxDQUFDO0FBbENELDRDQWtDQztBQUVELFNBQWdCLGtCQUFrQixDQUFDLDJCQUE4QyxFQUFFLFNBQWtDO0lBQ25ILElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLDJCQUEyQixDQUFDLEVBQUU7UUFDL0MsMkJBQTJCLEdBQUcsQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0tBQzdEO0lBQ0QsTUFBTSx1QkFBdUIsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQzFDLDJCQUEyQixDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsdUJBQXVCLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDL0UsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxTQUFTLEVBQUUsRUFBRSxDQUFDLHVCQUF1QixDQUFDLEdBQUcsQ0FBQyxJQUFBLG1DQUEyQixFQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN6RyxPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsdUJBQXVCLENBQWEsQ0FBQztBQUN6RCxDQUFDO0FBUkQsZ0RBUUM7QUFFRCxTQUFzQixrQkFBa0IsQ0FBQyxHQUFXLEVBQUUsSUFBa0I7OztRQUN0RSxzSkFBc0o7UUFDdEosTUFBTSxNQUFNLEdBQUcsTUFBTSxXQUFXLG1CQUFNLElBQUksRUFBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxNQUFNLEVBQUUseUJBQXlCLEVBQUUsQ0FBQyxDQUFDO1FBQ2xHLElBQUksTUFBQSxNQUFNLGFBQU4sTUFBTSx1QkFBTixNQUFNLENBQUUscUJBQXFCLDBDQUFFLEtBQUssRUFBRTtZQUN4QyxNQUFNLEtBQUssQ0FBQyxNQUFNLENBQUMscUJBQXFCLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDakQ7UUFDRCw2REFBNkQ7UUFDN0QsYUFBYTtRQUNiLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxJQUFJLE1BQU0sQ0FBQyxFQUFFLEVBQUU7WUFDcEMsK0hBQStIO1lBQy9ILE9BQU8sTUFBZ0MsQ0FBQztTQUN6QztRQUNELE9BQU8sTUFBTSxDQUFDLFdBQVcsQ0FBQzs7Q0FDM0I7QUFiRCxnREFhQyJ9