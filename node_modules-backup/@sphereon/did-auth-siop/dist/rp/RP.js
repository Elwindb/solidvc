"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.RP = void 0;
const uuid_1 = require("uuid");
const authorization_request_1 = require("../authorization-request");
const Opts_1 = require("../authorization-request/Opts");
const authorization_response_1 = require("../authorization-response");
const helpers_1 = require("../helpers");
const types_1 = require("../types");
const Opts_2 = require("./Opts");
const RPBuilder_1 = require("./RPBuilder");
class RP {
    get sessionManager() {
        return this._sessionManager;
    }
    constructor(opts) {
        var _a, _b;
        // const claims = opts.builder?.claims || opts.createRequestOpts?.payload.claims;
        const authReqOpts = (0, Opts_2.createRequestOptsFromBuilderOrExistingOpts)(opts);
        this._createRequestOptions = Object.assign(Object.assign({}, authReqOpts), { payload: Object.assign({}, authReqOpts.payload) });
        this._verifyResponseOptions = Object.assign({}, (0, Opts_2.createVerifyResponseOptsFromBuilderOrExistingOpts)(opts));
        this._eventEmitter = (_a = opts.builder) === null || _a === void 0 ? void 0 : _a.eventEmitter;
        this._sessionManager = (_b = opts.builder) === null || _b === void 0 ? void 0 : _b.sessionManager;
    }
    static fromRequestOpts(opts) {
        return new RP({ createRequestOpts: opts });
    }
    static builder(opts) {
        return RPBuilder_1.RPBuilder.newInstance(opts === null || opts === void 0 ? void 0 : opts.requestVersion);
    }
    createAuthorizationRequest(opts) {
        return __awaiter(this, void 0, void 0, function* () {
            const authorizationRequestOpts = this.newAuthorizationRequestOpts(opts);
            return authorization_request_1.AuthorizationRequest.fromOpts(authorizationRequestOpts)
                .then((authorizationRequest) => {
                void this.emitEvent(types_1.AuthorizationEvents.ON_AUTH_REQUEST_CREATED_SUCCESS, {
                    correlationId: opts.correlationId,
                    subject: authorizationRequest,
                });
                return authorizationRequest;
            })
                .catch((error) => {
                void this.emitEvent(types_1.AuthorizationEvents.ON_AUTH_REQUEST_CREATED_FAILED, {
                    correlationId: opts.correlationId,
                    error,
                });
                throw error;
            });
        });
    }
    createAuthorizationRequestURI(opts) {
        return __awaiter(this, void 0, void 0, function* () {
            const authorizationRequestOpts = this.newAuthorizationRequestOpts(opts);
            return yield authorization_request_1.URI.fromOpts(authorizationRequestOpts)
                .then((uri) => __awaiter(this, void 0, void 0, function* () {
                void this.emitEvent(types_1.AuthorizationEvents.ON_AUTH_REQUEST_CREATED_SUCCESS, {
                    correlationId: opts.correlationId,
                    subject: yield authorization_request_1.AuthorizationRequest.fromOpts(authorizationRequestOpts),
                });
                return uri;
            }))
                .catch((error) => {
                void this.emitEvent(types_1.AuthorizationEvents.ON_AUTH_REQUEST_CREATED_FAILED, {
                    correlationId: opts.correlationId,
                    error,
                });
                throw error;
            });
        });
    }
    signalAuthRequestRetrieved(opts) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.sessionManager) {
                throw Error(`Cannot signal auth request retrieval when no session manager is registered`);
            }
            const state = yield this.sessionManager.getRequestStateByCorrelationId(opts.correlationId, true);
            void this.emitEvent((opts === null || opts === void 0 ? void 0 : opts.error) ? types_1.AuthorizationEvents.ON_AUTH_REQUEST_SENT_FAILED : types_1.AuthorizationEvents.ON_AUTH_REQUEST_SENT_SUCCESS, Object.assign(Object.assign({ correlationId: opts.correlationId }, (!(opts === null || opts === void 0 ? void 0 : opts.error) ? { subject: state.request } : {})), ((opts === null || opts === void 0 ? void 0 : opts.error) ? { error: opts.error } : {})));
        });
    }
    verifyAuthorizationResponse(authorizationResponsePayload, opts) {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            const state = (opts === null || opts === void 0 ? void 0 : opts.state) || this.verifyResponseOptions.state;
            let correlationId = (opts === null || opts === void 0 ? void 0 : opts.correlationId) || state;
            let authorizationResponse;
            try {
                authorizationResponse = yield authorization_response_1.AuthorizationResponse.fromPayload(authorizationResponsePayload);
            }
            catch (error) {
                void this.emitEvent(types_1.AuthorizationEvents.ON_AUTH_RESPONSE_RECEIVED_FAILED, {
                    correlationId: correlationId !== null && correlationId !== void 0 ? correlationId : (0, uuid_1.v4)(),
                    subject: authorizationResponsePayload,
                    error,
                });
                throw error;
            }
            try {
                const verifyAuthenticationResponseOpts = yield this.newVerifyAuthorizationResponseOpts(authorizationResponse, Object.assign(Object.assign({}, opts), { correlationId }));
                correlationId = (_a = verifyAuthenticationResponseOpts.correlationId) !== null && _a !== void 0 ? _a : correlationId;
                void this.emitEvent(types_1.AuthorizationEvents.ON_AUTH_RESPONSE_RECEIVED_SUCCESS, {
                    correlationId,
                    subject: authorizationResponse,
                });
                const verifiedAuthorizationResponse = yield authorizationResponse.verify(verifyAuthenticationResponseOpts);
                void this.emitEvent(types_1.AuthorizationEvents.ON_AUTH_RESPONSE_VERIFIED_SUCCESS, {
                    correlationId,
                    subject: authorizationResponse,
                });
                return verifiedAuthorizationResponse;
            }
            catch (error) {
                void this.emitEvent(types_1.AuthorizationEvents.ON_AUTH_RESPONSE_VERIFIED_FAILED, {
                    correlationId,
                    subject: authorizationResponse,
                    error,
                });
                throw error;
            }
        });
    }
    get createRequestOptions() {
        return this._createRequestOptions;
    }
    get verifyResponseOptions() {
        return this._verifyResponseOptions;
    }
    newAuthorizationRequestOpts(opts) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o, _p, _q, _r, _s, _t, _u, _v, _w, _x, _y, _z;
        const nonceWithTarget = typeof opts.nonce === 'string'
            ? { propertyValue: opts.nonce, targets: authorization_request_1.PropertyTarget.REQUEST_OBJECT }
            : opts === null || opts === void 0 ? void 0 : opts.nonce;
        const stateWithTarget = typeof opts.state === 'string'
            ? { propertyValue: opts.state, targets: authorization_request_1.PropertyTarget.REQUEST_OBJECT }
            : opts === null || opts === void 0 ? void 0 : opts.state;
        const claimsWithTarget = (opts === null || opts === void 0 ? void 0 : opts.claims) && !('propertyValue' in opts.claims)
            ? { propertyValue: opts.claims, targets: authorization_request_1.PropertyTarget.REQUEST_OBJECT }
            : opts === null || opts === void 0 ? void 0 : opts.claims;
        const version = (_a = opts === null || opts === void 0 ? void 0 : opts.version) !== null && _a !== void 0 ? _a : this._createRequestOptions.version;
        if (!version) {
            throw Error(types_1.SIOPErrors.NO_REQUEST_VERSION);
        }
        const referenceURI = (_b = opts.requestByReferenceURI) !== null && _b !== void 0 ? _b : (_d = (_c = this._createRequestOptions) === null || _c === void 0 ? void 0 : _c.requestObject) === null || _d === void 0 ? void 0 : _d.reference_uri;
        let responseURIType = opts === null || opts === void 0 ? void 0 : opts.responseURIType;
        let responseURI = (_f = (_e = this._createRequestOptions.requestObject.payload) === null || _e === void 0 ? void 0 : _e.redirect_uri) !== null && _f !== void 0 ? _f : (_g = this._createRequestOptions.payload) === null || _g === void 0 ? void 0 : _g.redirect_uri;
        if (responseURI) {
            responseURIType = 'redirect_uri';
        }
        else {
            responseURI =
                (_k = (_h = opts.responseURI) !== null && _h !== void 0 ? _h : (_j = this._createRequestOptions.requestObject.payload) === null || _j === void 0 ? void 0 : _j.response_uri) !== null && _k !== void 0 ? _k : (_l = this._createRequestOptions.payload) === null || _l === void 0 ? void 0 : _l.response_uri;
            responseURIType = (_m = opts === null || opts === void 0 ? void 0 : opts.responseURIType) !== null && _m !== void 0 ? _m : 'response_uri';
        }
        if (!responseURI) {
            throw Error(`A response or redirect URI is required at this point`);
        }
        else {
            if (responseURIType === 'redirect_uri') {
                if (((_p = (_o = this._createRequestOptions) === null || _o === void 0 ? void 0 : _o.requestObject) === null || _p === void 0 ? void 0 : _p.payload) && !((_r = (_q = this._createRequestOptions.requestObject) === null || _q === void 0 ? void 0 : _q.payload) === null || _r === void 0 ? void 0 : _r.redirect_uri)) {
                    this._createRequestOptions.requestObject.payload.redirect_uri = responseURI;
                }
                if (!referenceURI && !((_s = this._createRequestOptions.payload) === null || _s === void 0 ? void 0 : _s.redirect_uri)) {
                    this._createRequestOptions.payload.redirect_uri = responseURI;
                }
            }
            else if (responseURIType === 'response_uri') {
                if (((_u = (_t = this._createRequestOptions) === null || _t === void 0 ? void 0 : _t.requestObject) === null || _u === void 0 ? void 0 : _u.payload) && !((_w = (_v = this._createRequestOptions.requestObject) === null || _v === void 0 ? void 0 : _v.payload) === null || _w === void 0 ? void 0 : _w.response_uri)) {
                    this._createRequestOptions.requestObject.payload.response_uri = responseURI;
                }
                if (!referenceURI && !((_x = this._createRequestOptions.payload) === null || _x === void 0 ? void 0 : _x.response_uri)) {
                    this._createRequestOptions.payload.response_uri = responseURI;
                }
            }
        }
        const newOpts = Object.assign(Object.assign({}, this._createRequestOptions), { version });
        newOpts.requestObject.payload = (_y = newOpts.requestObject.payload) !== null && _y !== void 0 ? _y : {};
        newOpts.payload = (_z = newOpts.payload) !== null && _z !== void 0 ? _z : {};
        if (referenceURI) {
            if (newOpts.requestObject.passBy && newOpts.requestObject.passBy !== types_1.PassBy.REFERENCE) {
                throw Error(`Cannot pass by reference with uri ${referenceURI} when mode is ${newOpts.requestObject.passBy}`);
            }
            newOpts.requestObject.reference_uri = referenceURI;
            newOpts.requestObject.passBy = types_1.PassBy.REFERENCE;
        }
        const state = (0, helpers_1.getState)(stateWithTarget.propertyValue);
        if (stateWithTarget.propertyValue) {
            if ((0, Opts_2.isTargetOrNoTargets)(authorization_request_1.PropertyTarget.AUTHORIZATION_REQUEST, stateWithTarget.targets)) {
                newOpts.payload.state = state;
            }
            if ((0, Opts_2.isTargetOrNoTargets)(authorization_request_1.PropertyTarget.REQUEST_OBJECT, stateWithTarget.targets)) {
                newOpts.requestObject.payload.state = state;
            }
        }
        const nonce = (0, helpers_1.getNonce)(state, nonceWithTarget.propertyValue);
        if (nonceWithTarget.propertyValue) {
            if ((0, Opts_2.isTargetOrNoTargets)(authorization_request_1.PropertyTarget.AUTHORIZATION_REQUEST, nonceWithTarget.targets)) {
                newOpts.payload.nonce = nonce;
            }
            if ((0, Opts_2.isTargetOrNoTargets)(authorization_request_1.PropertyTarget.REQUEST_OBJECT, nonceWithTarget.targets)) {
                newOpts.requestObject.payload.nonce = nonce;
            }
        }
        if (claimsWithTarget === null || claimsWithTarget === void 0 ? void 0 : claimsWithTarget.propertyValue) {
            if ((0, Opts_2.isTargetOrNoTargets)(authorization_request_1.PropertyTarget.AUTHORIZATION_REQUEST, claimsWithTarget.targets)) {
                newOpts.payload.claims = Object.assign(Object.assign({}, newOpts.payload.claims), claimsWithTarget.propertyValue);
            }
            if ((0, Opts_2.isTargetOrNoTargets)(authorization_request_1.PropertyTarget.REQUEST_OBJECT, claimsWithTarget.targets)) {
                newOpts.requestObject.payload.claims = Object.assign(Object.assign({}, newOpts.requestObject.payload.claims), claimsWithTarget.propertyValue);
            }
        }
        return newOpts;
    }
    newVerifyAuthorizationResponseOpts(authorizationResponse, opts) {
        var _a, _b, _c, _d, _e, _f, _g;
        return __awaiter(this, void 0, void 0, function* () {
            let correlationId = (_a = opts === null || opts === void 0 ? void 0 : opts.correlationId) !== null && _a !== void 0 ? _a : this._verifyResponseOptions.correlationId;
            let state = (_b = opts === null || opts === void 0 ? void 0 : opts.state) !== null && _b !== void 0 ? _b : this._verifyResponseOptions.state;
            let nonce = (_c = opts === null || opts === void 0 ? void 0 : opts.nonce) !== null && _c !== void 0 ? _c : this._verifyResponseOptions.nonce;
            if (this.sessionManager) {
                const resNonce = (yield authorizationResponse.getMergedProperty('nonce', false));
                const resState = (yield authorizationResponse.getMergedProperty('state', false));
                correlationId = yield this.sessionManager.getCorrelationIdByNonce(resNonce, false);
                if (!correlationId) {
                    correlationId = yield this.sessionManager.getCorrelationIdByState(resState, false);
                }
                if (!correlationId) {
                    correlationId = nonce;
                }
                const requestState = yield this.sessionManager.getRequestStateByCorrelationId(correlationId, false);
                if (requestState) {
                    const reqNonce = yield requestState.request.getMergedProperty('nonce');
                    const reqState = yield requestState.request.getMergedProperty('state');
                    nonce = nonce !== null && nonce !== void 0 ? nonce : reqNonce;
                    state = state !== null && state !== void 0 ? state : reqState;
                }
            }
            return Object.assign(Object.assign(Object.assign({}, this._verifyResponseOptions), opts), { correlationId, audience: (_f = (_e = (_d = opts === null || opts === void 0 ? void 0 : opts.audience) !== null && _d !== void 0 ? _d : this._verifyResponseOptions.audience) !== null && _e !== void 0 ? _e : this._verifyResponseOptions.verification.resolveOpts.jwtVerifyOpts.audience) !== null && _f !== void 0 ? _f : this._createRequestOptions.payload.client_id, state,
                nonce, verification: (0, Opts_1.mergeVerificationOpts)(this._verifyResponseOptions, opts), presentationDefinitions: (_g = opts === null || opts === void 0 ? void 0 : opts.presentationDefinitions) !== null && _g !== void 0 ? _g : this._verifyResponseOptions.presentationDefinitions });
        });
    }
    emitEvent(type, payload) {
        return __awaiter(this, void 0, void 0, function* () {
            if (this._eventEmitter) {
                try {
                    this._eventEmitter.emit(type, new types_1.AuthorizationEvent(payload));
                }
                catch (e) {
                    //Let's make sure events do not cause control flow issues
                    console.log(`Could not emit event ${type} for ${payload.correlationId} initial error if any: ${payload === null || payload === void 0 ? void 0 : payload.error}`);
                }
            }
        });
    }
    addEventListener(register) {
        if (!this._eventEmitter) {
            throw Error('Cannot add listeners if no event emitter is available');
        }
        const events = Array.isArray(register.event) ? register.event : [register.event];
        for (const event of events) {
            this._eventEmitter.addListener(event, register.listener);
        }
    }
}
exports.RP = RP;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUlAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcnAvUlAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBRUEsK0JBQW9DO0FBRXBDLG9FQVFrQztBQUNsQyx3REFBc0U7QUFDdEUsc0VBQXVJO0FBQ3ZJLHdDQUFnRDtBQUNoRCxvQ0Fha0I7QUFFbEIsaUNBQTRJO0FBQzVJLDJDQUF3QztBQUd4QyxNQUFhLEVBQUU7SUFDYixJQUFJLGNBQWM7UUFDaEIsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDO0lBQzlCLENBQUM7SUFPRCxZQUFvQixJQUluQjs7UUFDQyxpRkFBaUY7UUFDakYsTUFBTSxXQUFXLEdBQUcsSUFBQSxpREFBMEMsRUFBQyxJQUFJLENBQUMsQ0FBQztRQUNyRSxJQUFJLENBQUMscUJBQXFCLG1DQUFRLFdBQVcsS0FBRSxPQUFPLG9CQUFPLFdBQVcsQ0FBQyxPQUFPLElBQUksQ0FBQztRQUNyRixJQUFJLENBQUMsc0JBQXNCLHFCQUFRLElBQUEsd0RBQWlELEVBQUMsSUFBSSxDQUFDLENBQUUsQ0FBQztRQUM3RixJQUFJLENBQUMsYUFBYSxHQUFHLE1BQUEsSUFBSSxDQUFDLE9BQU8sMENBQUUsWUFBWSxDQUFDO1FBQ2hELElBQUksQ0FBQyxlQUFlLEdBQUcsTUFBQSxJQUFJLENBQUMsT0FBTywwQ0FBRSxjQUFjLENBQUM7SUFDdEQsQ0FBQztJQUVNLE1BQU0sQ0FBQyxlQUFlLENBQUMsSUFBb0M7UUFDaEUsT0FBTyxJQUFJLEVBQUUsQ0FBQyxFQUFFLGlCQUFpQixFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVNLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBNEM7UUFDaEUsT0FBTyxxQkFBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLGFBQUosSUFBSSx1QkFBSixJQUFJLENBQUUsY0FBYyxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVZLDBCQUEwQixDQUFDLElBU3ZDOztZQUND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