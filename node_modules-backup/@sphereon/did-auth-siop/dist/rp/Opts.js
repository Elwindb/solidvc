"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.assignIfRequestObject = exports.assignIfAuth = exports.isTarget = exports.isTargetOrNoTargets = exports.createVerifyResponseOptsFromBuilderOrExistingOpts = exports.createRequestOptsFromBuilderOrExistingOpts = void 0;
const authorization_request_1 = require("../authorization-request");
const did_1 = require("../did");
// import { CreateAuthorizationRequestOptsSchema } from '../schemas';
const types_1 = require("../types");
const createRequestOptsFromBuilderOrExistingOpts = (opts) => {
    var _a, _b;
    const version = opts.builder ? opts.builder.getSupportedRequestVersion() : opts.createRequestOpts.version;
    if (!version) {
        throw Error(types_1.SIOPErrors.NO_REQUEST_VERSION);
    }
    // eslint-disable-next-line @typescript-eslint/ban-ts-comment
    // @ts-ignore
    const createRequestOpts = opts.builder
        ? {
            version,
            payload: Object.assign({}, opts.builder.authorizationRequestPayload),
            requestObject: Object.assign(Object.assign({}, opts.builder.requestObjectBy), { payload: Object.assign(Object.assign({}, opts.builder.requestObjectPayload), { subject_types_supported: (_a = opts.builder.clientMetadata) === null || _a === void 0 ? void 0 : _a.subjectTypesSupported, request_object_signing_alg_values_supported: (_b = opts.builder.clientMetadata) === null || _b === void 0 ? void 0 : _b.requestObjectSigningAlgValuesSupported }), signature: opts.builder.signature }),
            clientMetadata: opts.builder.clientMetadata,
        }
        : opts.createRequestOpts;
    /*const valid = true; // fixme: re-enable schema: CreateAuthorizationRequestOptsSchema(createRequestOpts);
    if (!valid) {
      // eslint-disable-next-line @typescript-eslint/ban-ts-comment
      //@ts-ignore
      throw new Error('RP builder validation error: ' + JSON.stringify(CreateAuthorizationRequestOptsSchema.errors));
    }*/
    return createRequestOpts;
};
exports.createRequestOptsFromBuilderOrExistingOpts = createRequestOptsFromBuilderOrExistingOpts;
const createVerifyResponseOptsFromBuilderOrExistingOpts = (opts) => {
    var _a, _b, _c;
    if (((_a = opts === null || opts === void 0 ? void 0 : opts.builder) === null || _a === void 0 ? void 0 : _a.resolvers.size) && ((_b = opts.builder) === null || _b === void 0 ? void 0 : _b.clientMetadata)) {
        opts.builder.clientMetadata.subject_syntax_types_supported = (0, did_1.mergeAllDidMethods)(opts.builder.clientMetadata.subject_syntax_types_supported, opts.builder.resolvers);
    }
    let resolver;
    if (opts.builder) {
        resolver = (0, did_1.getResolverUnion)(opts.builder.customResolver, opts.builder.clientMetadata.subject_syntax_types_supported, opts.builder.resolvers);
    }
    return opts.builder
        ? {
            verification: {
                mode: types_1.VerificationMode.INTERNAL,
                checkLinkedDomain: opts.builder.checkLinkedDomain,
                wellknownDIDVerifyCallback: opts.builder.wellknownDIDVerifyCallback,
                presentationVerificationCallback: opts.builder.presentationVerificationCallback,
                resolveOpts: {
                    subjectSyntaxTypesSupported: opts.builder.clientMetadata.subject_syntax_types_supported,
                    resolver: resolver,
                },
                supportedVersions: opts.builder.supportedVersions,
                revocationOpts: {
                    revocationVerification: opts.builder.revocationVerification,
                    revocationVerificationCallback: opts.builder.revocationVerificationCallback,
                },
                replayRegistry: opts.builder.sessionManager,
            },
            audience: opts.builder.clientId || ((_c = opts.builder.clientMetadata) === null || _c === void 0 ? void 0 : _c.client_id),
        }
        : opts.verifyOpts;
};
exports.createVerifyResponseOptsFromBuilderOrExistingOpts = createVerifyResponseOptsFromBuilderOrExistingOpts;
const isTargetOrNoTargets = (searchTarget, targets) => {
    if (!targets) {
        return true;
    }
    return (0, exports.isTarget)(searchTarget, targets);
};
exports.isTargetOrNoTargets = isTargetOrNoTargets;
const isTarget = (searchTarget, targets) => {
    return Array.isArray(targets) ? targets.includes(searchTarget) : targets === searchTarget;
};
exports.isTarget = isTarget;
const assignIfAuth = (opt, isDefaultTarget) => {
    if (isDefaultTarget
        ? (0, exports.isTargetOrNoTargets)(authorization_request_1.PropertyTarget.AUTHORIZATION_REQUEST, opt.targets)
        : (0, exports.isTarget)(authorization_request_1.PropertyTarget.AUTHORIZATION_REQUEST, opt.targets)) {
        return opt.propertyValue;
    }
    return undefined;
};
exports.assignIfAuth = assignIfAuth;
const assignIfRequestObject = (opt, isDefaultTarget) => {
    if (isDefaultTarget ? (0, exports.isTargetOrNoTargets)(authorization_request_1.PropertyTarget.REQUEST_OBJECT, opt.targets) : (0, exports.isTarget)(authorization_request_1.PropertyTarget.REQUEST_OBJECT, opt.targets)) {
        return opt.propertyValue;
    }
    return undefined;
};
exports.assignIfRequestObject = assignIfRequestObject;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT3B0cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ycC9PcHRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLG9FQUF1STtBQUV2SSxnQ0FBOEQ7QUFDOUQscUVBQXFFO0FBQ3JFLG9DQUF3SDtBQUlqSCxNQUFNLDBDQUEwQyxHQUFHLENBQUMsSUFBaUYsRUFBRSxFQUFFOztJQUM5SSxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLDBCQUEwQixFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUM7SUFDMUcsSUFBSSxDQUFDLE9BQU8sRUFBRTtRQUNaLE1BQU0sS0FBSyxDQUFDLGtCQUFVLENBQUMsa0JBQWtCLENBQUMsQ0FBQztLQUM1QztJQUVELDZEQUE2RDtJQUM3RCxhQUFhO0lBQ2IsTUFBTSxpQkFBaUIsR0FBbUMsSUFBSSxDQUFDLE9BQU87UUFDcEUsQ0FBQyxDQUFDO1lBQ0UsT0FBTztZQUNQLE9BQU8sb0JBQ0YsSUFBSSxDQUFDLE9BQU8sQ0FBQywyQkFBMkIsQ0FNNUM7WUFDRCxhQUFhLGtDQUNSLElBQUksQ0FBQyxPQUFPLENBQUMsZUFBZSxLQUMvQixPQUFPLGtDQUNELElBQUksQ0FBQyxPQUFPLENBQUMsb0JBQTZDLEtBQzlELHVCQUF1QixFQUFFLE1BQUEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLDBDQUFFLHFCQUFxQixFQUMzRSwyQ0FBMkMsRUFBRSxNQUFBLElBQUksQ0FBQyxPQUFPLENBQUMsY0FBYywwQ0FBRSxzQ0FBc0MsS0FFbEgsU0FBUyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxHQUNsQztZQUNELGNBQWMsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLGNBQW9DO1NBQ2xFO1FBQ0gsQ0FBQyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQztJQUUzQjs7Ozs7T0FL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