"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.InMemoryRPSessionManager = void 0;
const types_1 = require("../types");
/**
 * Please note that this session manager is not really meant to be used in large production settings, as it stores everything in memory!
 * It also doesn't do scheduled cleanups. It runs a cleanup whenever a request or response is received. In a high-volume production setting you will want scheduled cleanups running in the background
 * Since this is a low level library we have not created a full-fledged implementation.
 * We suggest to create your own implementation using the event system of the library
 */
class InMemoryRPSessionManager {
    static getKeysForCorrelationId(mapping, correlationId) {
        return Object.entries(mapping)
            .filter((entry) => entry[1] === correlationId)
            .map((filtered) => Number.parseInt(filtered[0]));
    }
    constructor(eventEmitter, opts) {
        var _a;
        this.authorizationRequests = {};
        this.authorizationResponses = {};
        // stored by hashcode
        this.nonceMapping = {};
        // stored by hashcode
        this.stateMapping = {};
        if (!eventEmitter) {
            throw Error('RP Session manager depends on an event emitter in the application');
        }
        this.maxAgeInSeconds = (_a = opts === null || opts === void 0 ? void 0 : opts.maxAgeInSeconds) !== null && _a !== void 0 ? _a : 5 * 60;
        eventEmitter.on(types_1.AuthorizationEvents.ON_AUTH_REQUEST_CREATED_SUCCESS, this.onAuthorizationRequestCreatedSuccess.bind(this));
        eventEmitter.on(types_1.AuthorizationEvents.ON_AUTH_REQUEST_CREATED_FAILED, this.onAuthorizationRequestCreatedFailed.bind(this));
        eventEmitter.on(types_1.AuthorizationEvents.ON_AUTH_REQUEST_SENT_SUCCESS, this.onAuthorizationRequestSentSuccess.bind(this));
        eventEmitter.on(types_1.AuthorizationEvents.ON_AUTH_REQUEST_SENT_FAILED, this.onAuthorizationRequestSentFailed.bind(this));
        eventEmitter.on(types_1.AuthorizationEvents.ON_AUTH_RESPONSE_RECEIVED_SUCCESS, this.onAuthorizationResponseReceivedSuccess.bind(this));
        eventEmitter.on(types_1.AuthorizationEvents.ON_AUTH_RESPONSE_RECEIVED_FAILED, this.onAuthorizationResponseReceivedFailed.bind(this));
        eventEmitter.on(types_1.AuthorizationEvents.ON_AUTH_RESPONSE_VERIFIED_SUCCESS, this.onAuthorizationResponseVerifiedSuccess.bind(this));
        eventEmitter.on(types_1.AuthorizationEvents.ON_AUTH_RESPONSE_VERIFIED_FAILED, this.onAuthorizationResponseVerifiedFailed.bind(this));
    }
    getRequestStateByCorrelationId(correlationId, errorOnNotFound) {
        return __awaiter(this, void 0, void 0, function* () {
            return yield this.getFromMapping('correlationId', correlationId, this.authorizationRequests, errorOnNotFound);
        });
    }
    getRequestStateByNonce(nonce, errorOnNotFound) {
        return __awaiter(this, void 0, void 0, function* () {
            return yield this.getFromMapping('nonce', nonce, this.authorizationRequests, errorOnNotFound);
        });
    }
    getRequestStateByState(state, errorOnNotFound) {
        return __awaiter(this, void 0, void 0, function* () {
            return yield this.getFromMapping('state', state, this.authorizationRequests, errorOnNotFound);
        });
    }
    getResponseStateByCorrelationId(correlationId, errorOnNotFound) {
        return __awaiter(this, void 0, void 0, function* () {
            return yield this.getFromMapping('correlationId', correlationId, this.authorizationResponses, errorOnNotFound);
        });
    }
    getResponseStateByNonce(nonce, errorOnNotFound) {
        return __awaiter(this, void 0, void 0, function* () {
            return yield this.getFromMapping('nonce', nonce, this.authorizationResponses, errorOnNotFound);
        });
    }
    getResponseStateByState(state, errorOnNotFound) {
        return __awaiter(this, void 0, void 0, function* () {
            return yield this.getFromMapping('state', state, this.authorizationResponses, errorOnNotFound);
        });
    }
    getFromMapping(type, value, mapping, errorOnNotFound) {
        return __awaiter(this, void 0, void 0, function* () {
            const correlationId = yield this.getCorrelationIdImpl(type, value, errorOnNotFound);
            const result = mapping[correlationId];
            if (!result && errorOnNotFound) {
                throw Error(`Could not find ${type} from correlation id ${correlationId}`);
            }
            return result;
        });
    }
    onAuthorizationRequestCreatedSuccess(event) {
        return __awaiter(this, void 0, void 0, function* () {
            this.cleanup().catch((error) => console.log(JSON.stringify(error)));
            this.updateState('request', event, types_1.AuthorizationRequestStateStatus.CREATED).catch((error) => console.log(JSON.stringify(error)));
        });
    }
    onAuthorizationRequestCreatedFailed(event) {
        return __awaiter(this, void 0, void 0, function* () {
            this.cleanup().catch((error) => console.log(JSON.stringify(error)));
            this.updateState('request', event, types_1.AuthorizationRequestStateStatus.ERROR).catch((error) => console.log(JSON.stringify(error)));
        });
    }
    onAuthorizationRequestSentSuccess(event) {
        return __awaiter(this, void 0, void 0, function* () {
            this.cleanup().catch((error) => console.log(JSON.stringify(error)));
            this.updateState('request', event, types_1.AuthorizationRequestStateStatus.SENT).catch((error) => console.log(JSON.stringify(error)));
        });
    }
    onAuthorizationRequestSentFailed(event) {
        return __awaiter(this, void 0, void 0, function* () {
            this.cleanup().catch((error) => console.log(JSON.stringify(error)));
            this.updateState('request', event, types_1.AuthorizationRequestStateStatus.ERROR).catch((error) => console.log(JSON.stringify(error)));
        });
    }
    onAuthorizationResponseReceivedSuccess(event) {
        return __awaiter(this, void 0, void 0, function* () {
            this.cleanup().catch((error) => console.log(JSON.stringify(error)));
            yield this.updateState('response', event, types_1.AuthorizationResponseStateStatus.RECEIVED);
        });
    }
    onAuthorizationResponseReceivedFailed(event) {
        return __awaiter(this, void 0, void 0, function* () {
            this.cleanup().catch((error) => console.log(JSON.stringify(error)));
            yield this.updateState('response', event, types_1.AuthorizationResponseStateStatus.ERROR);
        });
    }
    onAuthorizationResponseVerifiedFailed(event) {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.updateState('response', event, types_1.AuthorizationResponseStateStatus.ERROR);
        });
    }
    onAuthorizationResponseVerifiedSuccess(event) {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.updateState('response', event, types_1.AuthorizationResponseStateStatus.VERIFIED);
        });
    }
    getCorrelationIdByNonce(nonce, errorOnNotFound) {
        return __awaiter(this, void 0, void 0, function* () {
            return yield this.getCorrelationIdImpl('nonce', nonce, errorOnNotFound);
        });
    }
    getCorrelationIdByState(state, errorOnNotFound) {
        return __awaiter(this, void 0, void 0, function* () {
            return yield this.getCorrelationIdImpl('state', state, errorOnNotFound);
        });
    }
    getCorrelationIdImpl(type, value, errorOnNotFound) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!value || !type) {
                throw Error('No type or value provided');
            }
            if (type === 'correlationId') {
                return value;
            }
            const hash = yield hashCode(value);
            const correlationId = type === 'nonce' ? this.nonceMapping[hash] : this.stateMapping[hash];
            if (!correlationId && errorOnNotFound) {
                throw Error(`Could not find ${type} value for ${value}`);
            }
            return correlationId;
        });
    }
    updateMapping(mapping, event, key, value, allowExisting) {
        return __awaiter(this, void 0, void 0, function* () {
            const hash = yield hashcodeForValue(event, key);
            const existing = mapping[hash];
            if (existing) {
                if (!allowExisting) {
                    throw Error(`Mapping exists for key ${key} and we do not allow overwriting values`);
                }
                else if (value && existing !== value) {
                    throw Error('Value changed for key');
                }
            }
            if (!value) {
                delete mapping[hash];
            }
            else {
                mapping[hash] = value;
            }
        });
    }
    updateState(type, event, status) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!event) {
                throw new Error('event not present');
            }
            else if (!event.correlationId) {
                throw new Error(`'${type} ${status}' event without correlation id received`);
            }
            try {
                const eventState = Object.assign(Object.assign(Object.assign(Object.assign({ correlationId: event.correlationId }, (type === 'request' ? { request: event.subject } : {})), (type === 'response' ? { response: event.subject } : {})), (event.error ? { error: event.error } : {})), { status, timestamp: event.timestamp, lastUpdated: event.timestamp });
                if (type === 'request') {
                    this.authorizationRequests[event.correlationId] = eventState;
                    // We do not await these
                    this.updateMapping(this.nonceMapping, event, 'nonce', event.correlationId, true).catch((error) => console.log(JSON.stringify(error)));
                    this.updateMapping(this.stateMapping, event, 'state', event.correlationId, true).catch((error) => console.log(JSON.stringify(error)));
                }
                else {
                    this.authorizationResponses[event.correlationId] = eventState;
                }
            }
            catch (error) {
                console.log(`Error in update state happened: ${error}`);
                // TODO VDX-166 handle error
            }
        });
    }
    deleteStateForCorrelationId(correlationId) {
        return __awaiter(this, void 0, void 0, function* () {
            InMemoryRPSessionManager.cleanMappingForCorrelationId(this.nonceMapping, correlationId).catch((error) => console.log(JSON.stringify(error)));
            InMemoryRPSessionManager.cleanMappingForCorrelationId(this.stateMapping, correlationId).catch((error) => console.log(JSON.stringify(error)));
            delete this.authorizationRequests[correlationId];
            delete this.authorizationResponses[correlationId];
        });
    }
    static cleanMappingForCorrelationId(mapping, correlationId) {
        return __awaiter(this, void 0, void 0, function* () {
            const keys = InMemoryRPSessionManager.getKeysForCorrelationId(mapping, correlationId);
            if (keys && keys.length > 0) {
                keys.forEach((key) => delete mapping[key]);
            }
        });
    }
    cleanup() {
        return __awaiter(this, void 0, void 0, function* () {
            const now = Date.now();
            const maxAgeInMS = this.maxAgeInSeconds * 1000;
            const cleanupCorrelations = (reqByCorrelationId) => {
                const correlationId = reqByCorrelationId[0];
                const authRequest = reqByCorrelationId[1];
                if (authRequest) {
                    const ts = authRequest.lastUpdated || authRequest.timestamp;
                    if (maxAgeInMS !== 0 && now > ts + maxAgeInMS) {
                        this.deleteStateForCorrelationId(correlationId);
                    }
                }
            };
            Object.entries(this.authorizationRequests).forEach((reqByCorrelationId) => {
                cleanupCorrelations.call(this, reqByCorrelationId);
            });
            Object.entries(this.authorizationResponses).forEach((resByCorrelationId) => {
                cleanupCorrelations.call(this, resByCorrelationId);
            });
        });
    }
}
exports.InMemoryRPSessionManager = InMemoryRPSessionManager;
function hashcodeForValue(event, key) {
    return __awaiter(this, void 0, void 0, function* () {
        const value = (yield event.subject.getMergedProperty(key));
        if (!value) {
            throw Error(`No value found for key ${key} in Authorization Request`);
        }
        return hashCode(value);
    });
}
function hashCode(s) {
    let h = 1;
    for (let i = 0; i < s.length; i++)
        h = (Math.imul(31, h) + s.charCodeAt(i)) | 0;
    return h;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSW5NZW1vcnlSUFNlc3Npb25NYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3JwL0luTWVtb3J5UlBTZXNzaW9uTWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFJQSxvQ0FPa0I7QUFJbEI7Ozs7O0dBS0c7QUFDSCxNQUFhLHdCQUF3QjtJQVUzQixNQUFNLENBQUMsdUJBQXVCLENBQUMsT0FBK0IsRUFBRSxhQUFxQjtRQUMzRixPQUFPLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDO2FBQzNCLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLGFBQWEsQ0FBQzthQUM3QyxHQUFHLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNyRCxDQUFDO0lBRUQsWUFBbUIsWUFBMEIsRUFBRSxJQUFtQzs7UUFmakUsMEJBQXFCLEdBQThDLEVBQUUsQ0FBQztRQUN0RSwyQkFBc0IsR0FBK0MsRUFBRSxDQUFDO1FBRXpGLHFCQUFxQjtRQUNKLGlCQUFZLEdBQTJCLEVBQUUsQ0FBQztRQUMzRCxxQkFBcUI7UUFDSixpQkFBWSxHQUEyQixFQUFFLENBQUM7UUFVekQsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNqQixNQUFNLEtBQUssQ0FBQyxtRUFBbUUsQ0FBQyxDQUFDO1NBQ2xGO1FBQ0QsSUFBSSxDQUFDLGVBQWUsR0FBRyxNQUFBLElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSxlQUFlLG1DQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDdkQsWUFBWSxDQUFDLEVBQUUsQ0FBQywyQkFBbUIsQ0FBQywrQkFBK0IsRUFBRSxJQUFJLENBQUMsb0NBQW9DLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDM0gsWUFBWSxDQUFDLEVBQUUsQ0FBQywyQkFBbUIsQ0FBQyw4QkFBOEIsRUFBRSxJQUFJLENBQUMsbUNBQW1DLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDekgsWUFBWSxDQUFDLEVBQUUsQ0FBQywyQkFBbUIsQ0FBQyw0QkFBNEIsRUFBRSxJQUFJLENBQUMsaUNBQWlDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDckgsWUFBWSxDQUFDLEVBQUUsQ0FBQywyQkFBbUIsQ0FBQywyQkFBMkIsRUFBRSxJQUFJLENBQUMsZ0NBQWdDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDbkgsWUFBWSxDQUFDLEVBQUUsQ0FBQywyQkFBbUIsQ0FBQyxpQ0FBaUMsRUFBRSxJQUFJLENBQUMsc0NBQXNDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDL0gsWUFBWSxDQUFDLEVBQUUsQ0FBQywyQkFBbUIsQ0FBQyxnQ0FBZ0MsRUFBRSxJQUFJLENBQUMscUNBQXFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDN0gsWUFBWSxDQUFDLEVBQUUsQ0FBQywyQkFBbUIsQ0FBQyxpQ0FBaUMsRUFBRSxJQUFJLENBQUMsc0NBQXNDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDL0gsWUFBWSxDQUFDLEVBQUUsQ0FBQywyQkFBbUIsQ0FBQyxnQ0FBZ0MsRUFBRSxJQUFJLENBQUMscUNBQXFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDL0gsQ0FBQztJQUVLLDhCQUE4QixDQUFDLGFBQXFCLEVBQUUsZUFBeUI7O1lBQ25GLE9BQU8sTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLGVBQWUsRUFBRSxhQUFhLEVBQUUsSUFBSSxDQUFDLHFCQUFxQixFQUFFLGVBQWUsQ0FBQyxDQUFDO1FBQ2hILENBQUM7S0FBQTtJQUVLLHNCQUFzQixDQUFDLEtBQWEsRUFBRSxlQUF5Qjs7WUFDbkUsT0FBTyxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMscUJBQXFCLEVBQUUsZUFBZSxDQUFDLENBQUM7UUFDaEcsQ0FBQztLQUFBO0lBRUssc0JBQXNCLENBQUMsS0FBYSxFQUFFLGVBQXlCOztZQUNuRSxPQUFPLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxlQUFlLENBQUMsQ0FBQztRQUNoRyxDQUFDO0tBQUE7SUFFSywrQkFBK0IsQ0FBQyxhQUFxQixFQUFFLGVBQXlCOztZQUNwRixPQUFPLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxlQUFlLEVBQUUsYUFBYSxFQUFFLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxlQUFlLENBQUMsQ0FBQztRQUNqSCxDQUFDO0tBQUE7SUFFSyx1QkFBdUIsQ0FBQyxLQUFhLEVBQUUsZUFBeUI7O1lBQ3BFLE9BQU8sTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLHNCQUFzQixFQUFFLGVBQWUsQ0FBQyxDQUFDO1FBQ2pHLENBQUM7S0FBQTtJQUVLLHVCQUF1QixDQUFDLEtBQWEsRUFBRSxlQUF5Qjs7WUFDcEUsT0FBTyxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsc0JBQXNCLEVBQUUsZUFBZSxDQUFDLENBQUM7UUFDakcsQ0FBQztLQUFBO0lBRWEsY0FBYyxDQUMxQixJQUF5QyxFQUN6QyxLQUFhLEVBQ2IsT0FBMEIsRUFDMUIsZUFBeUI7O1lBRXpCLE1BQU0sYUFBYSxHQUFHLE1BQU0sSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsZUFBZSxDQUFDLENBQUM7WUFDcEYsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBTSxDQUFDO1lBQzNDLElBQUksQ0FBQyxNQUFNLElBQUksZUFBZSxFQUFFO2dCQUM5QixNQUFNLEtBQUssQ0FBQyxrQkFBa0IsSUFBSSx3QkFBd0IsYUFBYSxFQUFFLENBQUMsQ0FBQzthQUM1RTtZQUNELE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUM7S0FBQTtJQUVhLG9DQUFvQyxDQUFDLEtBQStDOztZQUNoRyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BFLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSx1Q0FBK0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkksQ0FBQztLQUFBO0lBRWEsbUNBQW1DLENBQUMsS0FBK0M7O1lBQy9GLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLHVDQUErQixDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqSSxDQUFDO0tBQUE7SUFFYSxpQ0FBaUMsQ0FBQyxLQUErQzs7WUFDN0YsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwRSxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsdUNBQStCLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2hJLENBQUM7S0FBQTtJQUVhLGdDQUFnQyxDQUFDLEtBQStDOztZQUM1RixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BFLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSx1Q0FBK0IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDakksQ0FBQztLQUFBO0lBRWEsc0NBQXNDLENBQUMsS0FBZ0Q7O1lBQ25HLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEUsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUUsd0NBQWdDLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDdkYsQ0FBQztLQUFBO0lBRWEscUNBQXFDLENBQUMsS0FBZ0Q7O1lBQ2xHLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEUsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUUsd0NBQWdDLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDcEYsQ0FBQztLQUFBO0lBRWEscUNBQXFDLENBQUMsS0FBZ0Q7O1lBQ2xHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLEVBQUUsS0FBSyxFQUFFLHdDQUFnQyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3BGLENBQUM7S0FBQTtJQUVhLHNDQUFzQyxDQUFDLEtBQWdEOztZQUNuRyxNQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLEtBQUssRUFBRSx3Q0FBZ0MsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN2RixDQUFDO0tBQUE7SUFFWSx1QkFBdUIsQ0FBQyxLQUFhLEVBQUUsZUFBeUI7O1lBQzNFLE9BQU8sTUFBTSxJQUFJLENBQUMsb0JBQW9CLENBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxlQUFlLENBQUMsQ0FBQztRQUMxRSxDQUFDO0tBQUE7SUFFWSx1QkFBdUIsQ0FBQyxLQUFhLEVBQUUsZUFBeUI7O1lBQzNFLE9BQU8sTUFBTSxJQUFJLENBQUMsb0JBQW9CLENBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxlQUFlLENBQUMsQ0FBQztRQUMxRSxDQUFDO0tBQUE7SUFFYSxvQkFBb0IsQ0FDaEMsSUFBeUMsRUFDekMsS0FBYSxFQUNiLGVBQXlCOztZQUV6QixJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsSUFBSSxFQUFFO2dCQUNuQixNQUFNLEtBQUssQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO2FBQzFDO1lBQ0QsSUFBSSxJQUFJLEtBQUssZUFBZSxFQUFFO2dCQUM1QixPQUFPLEtBQUssQ0FBQzthQUNkO1lBQ0QsTUFBTSxJQUFJLEdBQUcsTUFBTSxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbkMsTUFBTSxhQUFhLEdBQUcsSUFBSSxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMzRixJQUFJLENBQUMsYUFBYSxJQUFJLGVBQWUsRUFBRTtnQkFDckMsTUFBTSxLQUFLLENBQUMsa0JBQWtCLElBQUksY0FBYyxLQUFLLEVBQUUsQ0FBQyxDQUFDO2FBQzFEO1lBQ0QsT0FBTyxhQUFhLENBQUM7UUFDdkIsQ0FBQztLQUFBO0lBRWEsYUFBYSxDQUN6QixPQUErQixFQUMvQixLQUF1RSxFQUN2RSxHQUFXLEVBQ1gsS0FBeUIsRUFDekIsYUFBc0I7O1lBRXRCLE1BQU0sSUFBSSxHQUFHLE1BQU0sZ0JBQWdCLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ2hELE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMvQixJQUFJLFFBQVEsRUFBRTtnQkFDWixJQUFJLENBQUMsYUFBYSxFQUFFO29CQUNsQixNQUFNLEtBQUssQ0FBQywwQkFBMEIsR0FBRyx5Q0FBeUMsQ0FBQyxDQUFDO2lCQUNyRjtxQkFBTSxJQUFJLEtBQUssSUFBSSxRQUFRLEtBQUssS0FBSyxFQUFFO29CQUN0QyxNQUFNLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO2lCQUN0QzthQUNGO1lBQ0QsSUFBSSxDQUFDLEtBQUssRUFBRTtnQkFDVixPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUN0QjtpQkFBTTtnQkFDTCxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsS0FBSyxDQUFDO2FBQ3ZCO1FBQ0gsQ0FBQztLQUFBO0lBRWEsV0FBVyxDQUN2QixJQUE0QixFQUM1QixLQUF1RSxFQUN2RSxNQUEwRTs7WUFFMUUsSUFBSSxDQUFDLEtBQUssRUFBRTtnQkFDVixNQUFNLElBQUksS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUM7YUFDdEM7aUJBQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUU7Z0JBQy9CLE1BQU0sSUFBSSxLQUFLLENBQUMsSUFBSSxJQUFJLElBQUksTUFBTSx5Q0FBeUMsQ0FBQyxDQUFDO2FBQzlFO1lBQ0QsSUFBSTtnQkFDRixNQUFNLFVBQVUsNkRBQ2QsYUFBYSxFQUFFLEtBQUssQ0FBQyxhQUFhLElBQy9CLENBQUMsSUFBSSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FDdEQsQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUN4RCxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQzlDLE1BQU0sRUFDTixTQUFTLEVBQUUsS0FBSyxDQUFDLFNBQVMsRUFDMUIsV0FBVyxFQUFFLEtBQUssQ0FBQyxTQUFTLEdBQzdCLENBQUM7Z0JBQ0YsSUFBSSxJQUFJLEtBQUssU0FBUyxFQUFFO29CQUN0QixJQUFJLENBQUMscUJBQXFCLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxHQUFHLFVBQXVDLENBQUM7b0JBQzFGLHdCQUF3QjtvQkFDeEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsS0FBSyxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3RJLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLEtBQUssQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUN2STtxQkFBTTtvQkFDTCxJQUFJLENBQUMsc0JBQXNCLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxHQUFHLFVBQXdDLENBQUM7aUJBQzdGO2FBQ0Y7WUFBQyxPQUFPLEtBQWMsRUFBRTtnQkFDdkIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQ0FBbUMsS0FBSyxFQUFFLENBQUMsQ0FBQztnQkFDeEQsNEJBQTRCO2FBQzdCO1FBQ0gsQ0FBQztLQUFBO0lBRUssMkJBQTJCLENBQUMsYUFBcUI7O1lBQ3JELHdCQUF3QixDQUFDLDRCQUE0QixDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsYUFBYSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdJLHdCQUF3QixDQUFDLDRCQUE0QixDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsYUFBYSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdJLE9BQU8sSUFBSSxDQUFDLHFCQUFxQixDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBQ2pELE9BQU8sSUFBSSxDQUFDLHNCQUFzQixDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3BELENBQUM7S0FBQTtJQUNPLE1BQU0sQ0FBTyw0QkFBNEIsQ0FBQyxPQUErQixFQUFFLGFBQXFCOztZQUN0RyxNQUFNLElBQUksR0FBRyx3QkFBd0IsQ0FBQyx1QkFBdUIsQ0FBQyxPQUFPLEVBQUUsYUFBYSxDQUFDLENBQUM7WUFDdEYsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQzNCLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7YUFDNUM7UUFDSCxDQUFDO0tBQUE7SUFFYSxPQUFPOztZQUNuQixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDdkIsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUM7WUFFL0MsTUFBTSxtQkFBbUIsR0FBRyxDQUFDLGtCQUFvRixFQUFFLEVBQUU7Z0JBQ25ILE1BQU0sYUFBYSxHQUFHLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM1QyxNQUFNLFdBQVcsR0FBRyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDMUMsSUFBSSxXQUFXLEVBQUU7b0JBQ2YsTUFBTSxFQUFFLEdBQUcsV0FBVyxDQUFDLFdBQVcsSUFBSSxXQUFXLENBQUMsU0FBUyxDQUFDO29CQUM1RCxJQUFJLFVBQVUsS0FBSyxDQUFDLElBQUksR0FBRyxHQUFHLEVBQUUsR0FBRyxVQUFVLEVBQUU7d0JBQzdDLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxhQUFhLENBQUMsQ0FBQztxQkFDakQ7aUJBQ0Y7WUFDSCxDQUFDLENBQUM7WUFFRixNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLGtCQUFrQixFQUFFLEVBQUU7Z0JBQ3hFLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztZQUNyRCxDQUFDLENBQUMsQ0FBQztZQUNILE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsa0JBQWtCLEVBQUUsRUFBRTtnQkFDekUsbUJBQW1CLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO1lBQ3JELENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztLQUFBO0NBQ0Y7QUFsT0QsNERBa09DO0FBRUQsU0FBZSxnQkFBZ0IsQ0FBQyxLQUF1RSxFQUFFLEdBQVc7O1FBQ2xILE1BQU0sS0FBSyxHQUFHLENBQUMsTUFBTSxLQUFLLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxDQUFXLENBQUM7UUFDckUsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNWLE1BQU0sS0FBSyxDQUFDLDBCQUEwQixHQUFHLDJCQUEyQixDQUFDLENBQUM7U0FDdkU7UUFDRCxPQUFPLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN6QixDQUFDO0NBQUE7QUFFRCxTQUFTLFFBQVEsQ0FBQyxDQUFTO0lBQ3pCLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNWLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRTtRQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFaEYsT0FBTyxDQUFDLENBQUM7QUFDWCxDQUFDIn0=