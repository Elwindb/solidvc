import { createJWS, ES256KSigner } from 'did-jwt';
import stringify from 'fast-json-stable-stringify';
import { RPCError, createHandler } from 'rpc-utils';
import * as u8a from 'uint8arrays';
import elliptic from 'elliptic';
const EC = elliptic.ec;
const ec = new EC('secp256k1');
function toStableObject(obj) {
    return JSON.parse(stringify(obj));
}
export function encodeDID(publicKey) {
    const bytes = new Uint8Array(publicKey.length + 2);
    bytes[0] = 0xe7;
    bytes[1] = 0x01;
    bytes.set(publicKey, 2);
    return `did:key:z${u8a.toString(bytes, 'base58btc')}`;
}
function toGeneralJWS(jws) {
    const [protectedHeader, payload, signature] = jws.split('.');
    return {
        payload,
        signatures: [{ protected: protectedHeader, signature }],
    };
}
const sign = async (payload, did, secretKey, protectedHeader = {}) => {
    const kid = `${did}#${did.split(':')[2]}`;
    const signer = ES256KSigner(secretKey);
    const header = toStableObject(Object.assign(protectedHeader, { kid, alg: 'ES256K' }));
    return createJWS(typeof payload === 'string' ? payload : toStableObject(payload), signer, header);
};
const didMethods = {
    did_authenticate: async ({ did, secretKey }, params) => {
        const response = await sign({
            did,
            aud: params.aud,
            nonce: params.nonce,
            paths: params.paths,
            exp: Math.floor(Date.now() / 1000) + 600,
        }, did, secretKey);
        return toGeneralJWS(response);
    },
    did_createJWS: async ({ did, secretKey }, params) => {
        const requestDid = params.did.split('#')[0];
        if (requestDid !== did)
            throw new RPCError(4100, `Unknown DID: ${did}`);
        const jws = await sign(params.payload, did, secretKey, params.protected);
        return { jws: toGeneralJWS(jws) };
    },
    did_decryptJWE: async () => {
        return { cleartext: '' };
    },
};
export class Secp256k1Provider {
    constructor(seed) {
        const publicKey = ec.keyFromPrivate(seed).getPublic(true, 'array');
        const did = encodeDID(Uint8Array.from(publicKey));
        const handler = createHandler(didMethods);
        this._handle = async (msg) => await handler({ did, secretKey: seed }, msg);
    }
    get isDidProvider() {
        return true;
    }
    async send(msg) {
        return await this._handle(msg);
    }
}
//# sourceMappingURL=index.js.map